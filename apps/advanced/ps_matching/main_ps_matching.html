<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Propensity Score Matching Tool</title>
  <link rel="stylesheet" href="../../../shared/css/main.css">
  <script src="../../../shared/js/tracking.js"></script>
  <link rel="stylesheet" href="../../../shared/css/auth_bar.css">
  <link rel="stylesheet" href="main_ps_matching.css">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="../../../shared/js/predictor_utils.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-290ZJ9RE04"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-290ZJ9RE04');
  </script>
</head>

<body>
  <div class="auth-bar">
    <div class="auth-bar__container">
      <div></div>
      <div id="auth-bar-content" class="auth-bar__links">
        <a href="../../../admin_pages/login.html">Login</a>
        <a href="../../../admin_pages/register.html">Create Account</a>
      </div>
    </div>
  </div>

  <header class="intro hero-header">
    <div class="hero-header__top">
      <h1>Propensity Score Matching</h1>
      <div class="hero-context">
        <span class="badge">Causal Inference</span>
      </div>
    </div>
    <p class="hero-header__lede">
      Estimate causal treatment effects from observational marketing data using propensity score matching. Upload data with a treatment indicator and outcome, select covariates for balance, and the tool performs nearest-neighbor matching to create comparable treated and control groups.
    </p>
  </header>

  <main class="app-main">
    <!-- Overview Section -->
    <section class="test-overview">
      <h2>OVERVIEW &amp; APPROACH</h2>
      <div class="card">
        <p>
          <strong>Propensity Score Matching (PSM)</strong> is a technique for estimating causal effects from observational data. When we cannot randomly assign treatment (e.g., who receives a marketing campaign), treated and control groups may differ systematically. PSM addresses this by matching each treated unit to control units with similar <em>propensity scores</em>&mdash;the probability of receiving treatment given observed covariates.
        </p>
        <p class="equation">
          <strong>Step 1 &ndash; Propensity Score Model:</strong>
          $$ e(X_i) = \Pr(T_i = 1 \mid X_i) = \text{logit}^{-1}(\beta_0 + \beta_1 X_{1i} + \dots + \beta_p X_{pi}) $$
          We fit a logistic regression predicting treatment \(T\) from covariates \(X\). The fitted probability \(\hat{e}(X_i)\) is the propensity score.
        </p>
        <p class="equation">
          <strong>Step 2 &ndash; Matching:</strong>
          For each treated unit, find the control unit(s) with the closest propensity score. This creates a matched sample where treated and control groups are balanced on covariates.
        </p>
        <p class="equation">
          <strong>Step 3 &ndash; Treatment Effect:</strong>
          $$ \text{ATT} = \frac{1}{n_1} \sum_{T_i=1} \left[ Y_i - Y_{j(i)} \right] $$
          The <em>Average Treatment Effect on the Treated</em> (ATT) compares outcomes between each treated unit and its matched control(s).
        </p>
        <details class="additional-notes">
          <summary>When to use propensity score matching</summary>
          <p>
            PSM is appropriate when you have observational data where treatment was <em>not</em> randomly assigned (e.g., customers who self-selected into a loyalty program, users who happened to see an ad). You need: (1) a binary treatment indicator, (2) an outcome you want to measure the treatment effect on, and (3) covariates that predict treatment assignment and may confound the treatment-outcome relationship.
          </p>
          <p class="muted">
            <strong>Key limitation:</strong> PSM only adjusts for <em>observed</em> covariates. If unobserved factors influence both treatment and outcome (hidden confounding), the estimated effect may still be biased. This is why good causal reasoning and domain knowledge are essential.
          </p>
        </details>
        <details class="additional-notes">
          <summary>Interpreting the Average Treatment Effect on the Treated (ATT)</summary>
          <p>
            The ATT answers: "Among those who received treatment, what was the average effect compared to similar untreated individuals?" This is often the most policy-relevant question (e.g., "Did the campaign lift sales among people we actually targeted?").
          </p>
          <p class="muted">
            Note: ATT differs from ATE (Average Treatment Effect), which estimates the effect across the entire population. PSM with 1:1 matching typically estimates ATT.
          </p>
        </details>
      </div>
    </section>

    <!-- Scenario Section -->
    <section class="scenario-section">
      <h2>MARKETING SCENARIOS</h2>
      <div class="card">
        <div class="scenario-controls">
          <label for="scenario-select">Load a matching scenario:</label>
          <div class="scenario-controls__input">
            <select id="scenario-select">
              <option value="">Manual inputs (no preset)</option>
            </select>
            <button id="scenario-download" class="secondary hidden" type="button" disabled>
              Download scenario dataset
            </button>
          </div>
        </div>
        <div id="scenario-description">
          <p>
            Use presets to explore causal inference scenarios, such as <em>loyalty program enrollment</em> or <em>email campaign exposure</em>.
            Each scenario provides a raw data file with treatment, outcome, and covariates.
          </p>
        </div>
      </div>
    </section>

    <!-- Data Input Section -->
    <section class="inputs-panel">
      <h2>DATA &amp; VARIABLE SELECTION</h2>
      
      <div class="card data-entry-card">
        <div class="input-header">
          <h3>Upload Raw Data File</h3>
        </div>
        <p class="panel-intro">
          Upload a CSV file with case-level data including: a binary treatment indicator (0/1), an outcome variable, and covariates for matching. Headers are required.
        </p>
        <div class="dropzone" id="raw-dropzone" role="button" tabindex="0">
          <p class="dropzone-title">Drag &amp; Drop raw data file (.csv, .tsv, .txt)</p>
          <p class="dropzone-note">Include headers; must have treatment (binary), outcome, and covariate columns.</p>
          <button type="button" id="raw-browse" class="secondary">Browse files</button>
        </div>
        <input type="file" id="raw-input" accept=".csv,.tsv,.txt" hidden>
        
        <div class="template-buttons">
          <button type="button" id="raw-template-download">Download CSV template</button>
        </div>
        <p class="upload-status" id="raw-upload-status">No file uploaded.</p>
      </div>

      <!-- Variable Selection Panel -->
      <div id="variable-selection-panel" class="card variable-selection-panel hidden">
        <h3>Assign Variables for Matching</h3>
        <p>Select your treatment indicator, outcome variable, and covariates to balance on.</p>
        
        <div class="variable-selectors-grid psm-grid">
          <!-- Treatment Variable -->
          <div class="variable-column">
            <label for="treatment-select"><strong>Treatment Variable</strong> (binary)</label>
            <select id="treatment-select">
              <option value="">-- Select treatment --</option>
            </select>
            <div id="treatment-focal-wrapper" class="muted small hidden" style="margin-top: 0.5rem;">
              <label for="treatment-focal-select">Treated group (coded as 1):</label>
              <select id="treatment-focal-select"></select>
            </div>
            <p id="treatment-coding-note" class="muted" style="margin-top: 0.25rem;"></p>
          </div>
          
          <!-- Outcome Variable -->
          <div class="variable-column">
            <label for="outcome-select"><strong>Outcome Variable</strong></label>
            <select id="outcome-select">
              <option value="">-- Select outcome --</option>
            </select>
            <p class="muted small">Can be binary (0/1) or continuous. The ATT will measure the treatment effect on this variable.</p>
          </div>
          
          <!-- Covariates -->
          <div class="variable-column covariates-column">
            <label><strong>Covariates</strong> (for propensity model)</label>
            <p class="muted small">Select variables that may confound the treatment-outcome relationship.</p>
            <div id="covariate-list" class="predictor-list stacked"></div>
          </div>
        </div>
        
        <div id="assignment-summary" class="muted" style="margin-top: 1rem;"></div>
        <p id="input-status" class="muted"></p>
        <p id="row-filter-status" class="muted"></p>
      </div>

      <!-- Matching Options -->
      <div id="matching-options-panel" class="card hidden">
        <h3>Matching Options</h3>
        <div class="matching-options-grid">
          <div class="matching-option">
            <label for="matching-method">Matching Method</label>
            <select id="matching-method">
              <option value="nearest" selected>Nearest Neighbor (1:1)</option>
              <option value="nearest-k">Nearest Neighbor (1:k)</option>
              <option value="caliper">Caliper Matching</option>
            </select>
          </div>
          
          <div class="matching-option" id="k-matches-wrapper" style="display:none;">
            <label for="k-matches">Number of matches (k)</label>
            <input type="number" id="k-matches" min="1" max="10" value="3" step="1">
          </div>
          
          <div class="matching-option" id="caliper-wrapper">
            <label for="caliper-width">Caliper Width</label>
            <input type="number" id="caliper-width" min="0.01" max="1" value="0.2" step="0.01">
            <p class="muted small">Maximum PS difference for a valid match. 0.2 is a common default (0.2 SD of logit PS).</p>
          </div>
          
          <div class="matching-option">
            <label>
              <input type="checkbox" id="with-replacement" checked>
              <span>Match with replacement</span>
            </label>
            <p class="muted small">Allow control units to be matched to multiple treated units.</p>
          </div>
        </div>
        
        <button type="button" id="run-matching-btn" class="primary" style="margin-top: 1rem;">
          Run Matching Analysis
        </button>
      </div>
    </section>

    <!-- Propensity Score Diagnostics -->
    <section class="visual-output" aria-labelledby="visual-output-heading">
      <h2 id="visual-output-heading">PROPENSITY SCORE DIAGNOSTICS</h2>
      <div class="card">
        <!-- Propensity Score Distribution -->
        <article class="chart-card">
          <h3>Propensity Score Distribution</h3>
          <div id="plot-ps-distribution" class="chart-placeholder" role="img" aria-live="polite"
            aria-label="Histogram of propensity scores by treatment status."></div>
          <p id="plot-ps-distribution-caption" class="chart-note"></p>
          <details class="interpretation-aid">
            <summary>Interpretation Aid</summary>
            <p class="muted">
              <strong>What to look for:</strong> The histograms show the distribution of estimated propensity scores for treated (blue) and control (orange) groups. <em>Good overlap</em> means both distributions cover similar ranges&mdash;this indicates the groups are comparable and matching will work well.
            </p>
            <p class="muted">
              <strong>Warning signs:</strong> If distributions barely overlap (e.g., all treated units have high PS while controls have low PS), matching will be difficult and may produce biased estimates. This suggests fundamental differences between groups that PS matching cannot fully address.
            </p>
          </details>
        </article>
        
        <!-- Balance Plot (Love Plot) -->
        <article class="chart-card">
          <h3>Covariate Balance: Before vs. After Matching</h3>
          <div id="plot-balance" class="chart-placeholder" role="img" aria-live="polite"
            aria-label="Love plot showing standardized mean differences before and after matching."></div>
          <p id="plot-balance-caption" class="chart-note"></p>
          <details class="interpretation-aid">
            <summary>Interpretation Aid</summary>
            <p class="muted">
              <strong>Standardized Mean Difference (SMD):</strong> Each point shows how different treated and control groups are on a covariate, measured in standard deviation units. An SMD of 0.1 means the groups differ by 0.1 SDs.
            </p>
            <p class="muted">
              <strong>Balance thresholds:</strong> SMD &lt; 0.1 is generally considered "good balance." SMD between 0.1&ndash;0.25 is acceptable but not ideal. SMD &gt; 0.25 suggests meaningful imbalance that may bias treatment effect estimates.
            </p>
            <p class="muted">
              <strong>Before vs. After:</strong> Open circles show pre-matching imbalance; filled circles show post-matching balance. Effective matching should move all covariates closer to zero (the dashed vertical line).
            </p>
          </details>
        </article>
      </div>
    </section>

    <!-- Matching Summary Section -->
    <section class="matching-summary-section" aria-labelledby="matching-summary-heading">
      <h2 id="matching-summary-heading">MATCHING SUMMARY</h2>
      <div class="card">
        <div class="matching-stats-grid">
          <div class="stat-item">
            <span class="stat-label">Treated Units</span>
            <span class="stat-value" id="stat-n-treated">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Control Units</span>
            <span class="stat-value" id="stat-n-control">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Matched Pairs</span>
            <span class="stat-value" id="stat-matched-pairs">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Unmatched Treated</span>
            <span class="stat-value" id="stat-unmatched">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Mean PS (Treated)</span>
            <span class="stat-value" id="stat-mean-ps-treated">--</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Mean PS (Matched Control)</span>
            <span class="stat-value" id="stat-mean-ps-control">--</span>
          </div>
        </div>
        
        <div id="matching-quality-note" class="muted" style="margin-top: 1rem;"></div>
        
        <details class="interpretation-aid">
          <summary>Understanding Matching Quality</summary>
          <p class="muted">
            <strong>Matched pairs:</strong> The number of treated units successfully matched to control units. Higher is better (less data loss).
          </p>
          <p class="muted">
            <strong>Unmatched treated:</strong> Treated units that couldn't find a suitable control match within the caliper. If this is high, consider widening the caliper or reviewing common support.
          </p>
          <p class="muted">
            <strong>Mean propensity scores:</strong> After matching, mean PS should be similar between treated and matched controls. Large differences suggest matching wasn't fully effective.
          </p>
        </details>
      </div>
    </section>

    <!-- Covariate Balance Table -->
    <section class="balance-section" aria-labelledby="balance-heading">
      <h2 id="balance-heading">COVARIATE BALANCE TABLE</h2>
      <div class="card">
        <h3>Standardized Mean Differences</h3>
        <table class="summary-table balance-table">
          <thead>
            <tr>
              <th>Covariate</th>
              <th>Mean (Treated)</th>
              <th>Mean (Control)</th>
              <th>SMD Before</th>
              <th>Mean (Matched Ctrl)</th>
              <th>SMD After</th>
              <th>% Reduction</th>
            </tr>
          </thead>
          <tbody id="balance-table-body">
            <tr><td colspan="7">Run matching to see balance diagnostics.</td></tr>
          </tbody>
        </table>
        <p class="muted" style="margin-top: 0.75rem;">
          <strong>SMD interpretation:</strong> |SMD| &lt; 0.1 = excellent balance (green), 0.1&ndash;0.25 = acceptable (yellow), &gt; 0.25 = concerning (red).
        </p>
        <details class="interpretation-aid">
          <summary>About Standardized Mean Differences</summary>
          <p class="muted">
            The SMD measures the difference in means between treated and control groups, divided by the pooled standard deviation. Unlike raw differences, SMD is unit-free and comparable across variables.
          </p>
          <p class="muted">
            For categorical variables, SMD is calculated for each level (as a 0/1 indicator). The table reports the maximum SMD across levels.
          </p>
        </details>
      </div>
    </section>

    <!-- Treatment Effect Results -->
    <section class="test-results" aria-labelledby="test-results-heading">
      <h2 id="test-results-heading">TREATMENT EFFECT RESULTS</h2>

      <div class="card treatment-effect-card">
        <h3>Average Treatment Effect on the Treated (ATT)</h3>
        <div class="att-display">
          <div class="att-main">
            <span class="att-label">Estimated ATT:</span>
            <span class="att-value" id="att-estimate">--</span>
          </div>
          <div class="att-details">
            <div class="att-detail">
              <span class="label">Standard Error:</span>
              <span id="att-se">--</span>
            </div>
            <div class="att-detail">
              <span class="label">95% CI:</span>
              <span id="att-ci">--</span>
            </div>
            <div class="att-detail">
              <span class="label">t-statistic:</span>
              <span id="att-tstat">--</span>
            </div>
            <div class="att-detail">
              <span class="label">p-value:</span>
              <span id="att-pvalue">--</span>
            </div>
          </div>
        </div>
        
        <div class="outcome-means-grid" style="margin-top: 1.5rem;">
          <div class="outcome-mean">
            <span class="label">Mean Outcome (Treated):</span>
            <span id="mean-outcome-treated">--</span>
          </div>
          <div class="outcome-mean">
            <span class="label">Mean Outcome (Matched Control):</span>
            <span id="mean-outcome-control">--</span>
          </div>
        </div>
        
        <details class="interpretation-aid">
          <summary>Interpreting the ATT</summary>
          <p class="muted">
            <strong>What it means:</strong> The ATT estimates how much the treatment changed the outcome, on average, for those who received treatment. A positive ATT means treated units had higher outcomes than comparable controls; negative means lower.
          </p>
          <p class="muted">
            <strong>Statistical significance:</strong> If the p-value &lt; 0.05, we have evidence that the treatment had a non-zero effect. The confidence interval shows the plausible range of the true effect.
          </p>
          <p class="muted">
            <strong>Practical significance:</strong> Even a statistically significant effect may be too small to matter practically. Consider the effect size in the context of your business goals.
          </p>
        </details>
      </div>

      <div class="dual-panels">
        <article class="card dual-panel">
          <h3>Statistical Interpretation</h3>
          <p id="statistical-report">Run matching analysis to see results.</p>
        </article>
        <article class="card dual-panel">
          <h3>Managerial Takeaway</h3>
          <p id="managerial-report">Run matching analysis to see actionable insights.</p>
        </article>
      </div>
      
      <div class="card">
        <button type="button" id="download-matched-data" class="secondary" disabled>
          Download Matched Sample Data (CSV)
        </button>
        <p class="hint">
          The downloaded file includes the matched sample with propensity scores, match IDs, and outcomes.
        </p>
      </div>
    </section>

    <!-- Propensity Model Details (collapsed) -->
    <section class="propensity-model-section">
      <h2>PROPENSITY MODEL DETAILS</h2>
      <div class="card">
        <details class="propensity-model-details">
          <summary>View Propensity Score Model Coefficients</summary>
          <p class="muted">The propensity score model predicts treatment assignment from covariates using logistic regression.</p>
          <div id="ps-model-equation" class="regression-equation-text" style="margin: 1rem 0;">
            Run matching to see the propensity model.
          </div>
          <table class="summary-table">
            <thead>
              <tr>
                <th>Covariate</th>
                <th>Coefficient</th>
                <th>Std. Error</th>
                <th>z</th>
                <th>p-value</th>
                <th>Odds Ratio</th>
              </tr>
            </thead>
            <tbody id="ps-coef-table-body">
              <tr><td colspan="6">Run matching to see coefficients.</td></tr>
            </tbody>
          </table>
          <div class="ps-model-metrics" style="margin-top: 1rem;">
            <span><strong>Pseudo R²:</strong> <span id="ps-pseudo-r2">--</span></span>
            <span style="margin-left: 2rem;"><strong>Model χ²:</strong> <span id="ps-chi2">--</span></span>
            <span style="margin-left: 2rem;"><strong>p-value:</strong> <span id="ps-model-pvalue">--</span></span>
          </div>
        </details>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="footer-content">
      <div class="footer-nav">
        <a href="../../../index.html" class="back-link">← Back to Tool Selection</a>
      </div>
      <div class="footer-meta">
        <span class="meta-item">Created: 2025-01-15</span>
        <span class="separator">•</span>
        <span class="meta-item">Last Updated: 2025-05-28</span>
      </div>
      <div class="footer-citation">
        <div class="citation-label">Cite this tool:</div>
        <div class="citation-text">Baker, A. (2025). Propensity Score Matching Tool. <em>Dr. Baker's Marketing Tools</em>. Retrieved from <a href="https://drbakermarketing.com/apps/advanced/ps_matching/main_ps_matching.html" target="_blank">https://drbakermarketing.com/apps/advanced/ps_matching/main_ps_matching.html</a></div>
      </div>
      <div class="footer-copyright">
        &copy; 2025 Andrew Baker. All rights reserved.
      </div>
    </div>
  </footer>

  <script src="../../../shared/js/csv_utils.js"></script>
  <script src="../../../shared/js/stats_utils.js"></script>
  <script src="../../../shared/js/ui_utils.js"></script>
  <script src="../../../shared/js/auth_tracking.js"></script>
  <script src="../../../shared/js/auth_bar.js"></script>
  <script src="../../../shared/js/quiz_utils.js"></script>
  <script src="main_ps_matching.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      initQuizButton('ps_matching');
    });
  </script>
  <div id="psm-loading-overlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-content">
      <p><strong>Running propensity score matching…</strong></p>
      <p class="muted">Fitting model and matching units. Please wait.</p>
    </div>
  </div>
</body>

</html>
