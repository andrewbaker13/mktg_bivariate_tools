<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multinomial Logistic Regression Tool</title>
  <!-- Shared design system -->
  <link rel="stylesheet" href="../../shared/css/main.css">
  <!-- App-specific overrides -->
  <link rel="stylesheet" href="main_mn_log_regression.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <script src="../../shared/js/stats_utils.js"></script>
  <script src="../../shared/js/predictor_utils.js"></script>
  <script src="../../shared/js/csv_utils.js"></script>
  <script src="../../shared/js/fan_chart_utils.js"></script>
  <script src="../../shared/js/stacked_bar_utils.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
  <!-- This template mirrors the shared layout so new tools can copy/paste sections quickly. -->
  <main class="app-main">
    <header class="intro hero-header">
      <div class="hero-header__top">
        <h1>Multinomial Logistic Regression Tool</h1>
        <div class="hero-context">
          <span class="badge">Design prototype</span>
        </div>
      </div>
      <p class="hero-header__lede">
        Explore multinomial logistic regression for marketing outcomes with more than two categories (for example,
        multi-level brand choice or multi-step funnel stage). Upload raw data, select the outcome and predictors, and
        compare predicted class probabilities with diagnostics.
      </p>
    </header>

    <section class="test-overview" aria-labelledby="test-overview-heading">
      <h2 id="test-overview-heading">TEST OVERVIEW &amp; EQUATIONS</h2>
      <div class="card">
        <p>
          Multinomial logistic regression is used when the outcome has more than two unordered categories
          (for example, <em>Brand A / Brand B / Brand C</em> or <em>aware / considering / ready to buy</em>).
          It models how a set of predictors changes the probability of landing in each category, relative to a
          chosen reference outcome.
        </p>
        <p>
          For each non-reference outcome category \(j\), the model estimates a separate log-odds equation relative
          to the reference category \(\text{ref}\):
        </p>
        <p class="equation">
          $$
          \log \frac{P(Y = j)}{P(Y = \text{ref})}
          = \beta_{0j} + \beta_{1j} x_1 + \cdots + \beta_{pj} x_p,\quad j = 1, \ldots, K - 1.
          $$
        </p>
        <p>
          These log-odds are converted into predicted probabilities using the multinomial logistic (softmax) link:
        </p>
        <p class="equation">
          $$
          P(Y = j) = \frac{\exp(\eta_j)}{1 + \sum_{h \neq \text{ref}} \exp(\eta_h)},\quad
          P(Y = \text{ref}) = \frac{1}{1 + \sum_{h \neq \text{ref}} \exp(\eta_h)}
          $$
          where \(\eta_j = \beta_{0j} + \beta_{1j} x_1 + \cdots + \beta_{pj} x_p\).
        </p>
        <details class="intro-notes" open>
          <summary>Additional Notes / Formulas</summary>
          <p>
            Choosing the reference outcome category changes the interpretation of coefficients but not the underlying
            probabilities. A positive coefficient \(\beta_{kj}\) means that as predictor \(x_k\) increases, outcome
            \(j\) becomes more likely relative to the reference category, holding other predictors constant.
          </p>
        </details>
      </div>
    </section>

    <section class="scenario-section" aria-labelledby="scenario-heading">
      <h2 id="scenario-heading">MARKETING SCENARIOS</h2>
      <div class="card">
        <div class="scenario-controls">
          <label for="scenario-select">Practical scenario</label>
          <div class="scenario-controls__input">
            <select id="scenario-select">
              <option value="">Manual inputs (no preset)</option>
            </select>
            <button id="scenario-download" class="secondary hidden" type="button" disabled>Download scenario dataset</button>
          </div>
        </div>
        <div id="scenario-description">
          <p>Use presets to auto-load realistic marketing inputs, text, and any CSV/TSV data required for uploads. The download button exposes the exact dataset used so editors can tweak it in Excel or Numbers before re-uploading.</p>
        </div>
      </div>
    </section>

    <section class="input-card" aria-labelledby="inputs-heading">
      <h2 id="inputs-heading">INPUTS &amp; SETTINGS</h2>
      <article class="card data-entry-card">
        <div class="input-header">
          <h3>Upload data</h3>
        </div>
        <div class="mode-toggle" role="tablist" aria-label="Data entry mode">
          <button type="button" class="mode-button active" data-mode="raw-upload">Upload raw data</button>
        </div>

        <div class="mode-panels">
          <div class="mode-panel active" data-mode="raw-upload" id="template-raw-panel">
            <div class="data-import-block">
              <h4>Upload raw long-format data</h4>
              <p>The template shows <code>group,value,channel,note</code> columns so end users can include the outcome plus optional metadata (channel, creative, timestamp). Customize those columns to the raw format your tool expects, and call out when only two group labels are allowed.</p>
              <div id="template-raw-dropzone" class="dropzone" role="button" tabindex="0">
                <p class="dropzone-title">Drag &amp; drop raw case file</p>
                <p class="dropzone-note">Two columns minimum: group label and numeric metric.</p>
                <button type="button" id="template-raw-browse" class="secondary">Browse files</button>
              </div>
              <input type="file" id="template-raw-input" accept=".csv,.tsv,.txt" hidden>
              <div class="template-buttons">
                <button type="button" id="template-raw-download">Download raw template</button>
              </div>
              <p id="template-raw-feedback" class="upload-status" aria-live="polite">No raw file uploaded.</p>
            </div>
          </div>
        </div>

        <div class="input-group">
          <h3>Outcome &amp; Reference Category</h3>
          <p class="hint">
            Choose the multinomial outcome (with 2 or more categories) and which outcome level should serve as the
            reference (baseline) category in the model. Coefficients and probability plots will be interpreted relative
            to this reference outcome.
          </p>
          <label for="mnlog-outcome-select">Outcome variable (Y)</label>
          <select id="mnlog-outcome-select"></select>
          <label for="mnlog-outcome-ref-select">Reference outcome category</label>
          <select id="mnlog-outcome-ref-select"></select>
        </div>

        <div class="input-group">
          <h3>Select predictors</h3>
            <p class="hint">
              Check the box for each predictor you want to include in the model. For categorical predictors, the app will
              create one coefficient per non-reference category. For continuous predictors, the app will estimate a single
              slope per outcome contrast.
            </p>
          <div id="mnlog-predictor-list" class="predictor-list stacked"></div>
        </div>

        <div class="input-group">
          <label class="switch-option">
            <input type="checkbox" id="mnlog-standardize-continuous">
            <span>Standardize continuous predictors (mean 0, SD 1)</span>
          </label>
          <p class="hint">
            Standardization affects model fitting and effect plots only. Summary statistics always report predictors on their original scale.
          </p>
        </div>

        <div class="input-group">
          <button type="button" id="mnlog-run-model" class="primary">Run multinomial model</button>
          <p id="mnlog-run-status" class="upload-status" aria-live="polite"></p>
        </div>
      </article>

      <article class="card analysis-settings test-options">
        <h3>Analysis Settings</h3>
        <div class="confidence-buttons" role="group" aria-label="Select confidence level">
          <button class="confidence-button" data-level="0.90">90% Conf.</button>
          <button class="confidence-button active" data-level="0.95">95% Conf.</button>
          <button class="confidence-button" data-level="0.99">99% Conf.</button>
        </div>
        <div class="input-group">
          <label for="alpha">Significance level (&alpha;)</label>
          <input type="number" id="alpha" min="0.001" max="0.2" step="0.001" value="0.050">
        </div>
        <details class="advanced-details">
          <summary>Advanced analysis settings</summary>
          <p>Adjust optimization settings for the multinomial model. Defaults are suitable for most datasets; increase the maximum iterations or decrease the step size if convergence warnings appear.</p>
          <div class="input-grid">
            <div>
              <label for="mnlog-max-iter">Max iterations</label>
              <input type="number" id="mnlog-max-iter" min="50" max="50000" step="50" value="200">
            </div>
            <div>
              <label for="mnlog-step-size">Step size (gradient ascent)</label>
              <input type="number" id="mnlog-step-size" min="0.01" max="1" step="0.01" value="0.20">
            </div>
          </div>
          <p class="hint">Higher max iterations (up to 50,000) can improve convergence for difficult models but will increase run time.</p>
          <label class="switch-option" style="margin-top: 0.75rem;">
            <input type="checkbox" id="mnlog-use-momentum">
            <span>Use momentum on gradient updates (helps when convergence is slow)</span>
          </label>
        </details>
      </article>
    </section>

    <section class="visual-output" aria-labelledby="visual-output-heading">
      <h2 id="visual-output-heading">VISUAL OUTPUT</h2>
      <div class="card">
        <div class="chart-grid">
          <article class="chart-card">
            <h3>Predicted probabilities vs. focal predictor</h3>
            <div class="scenario-controls" style="margin-bottom: 1rem;">
              <label for="mnlog-focal-select">Focal predictor</label>
              <div class="scenario-controls__input">
                <select id="mnlog-focal-select"></select>
              </div>
            </div>
            <div class="scenario-controls" style="margin-bottom: 1rem;">
              <label for="effect-chart-category-select">Display category</label>
              <div class="scenario-controls__input">
                <select id="effect-chart-category-select">
                  <option value="all">All vs. reference</option>
                </select>
              </div>
            </div>
            <div class="range-controls" id="mnlog-range-controls">
              <span>Focal range (continuous):</span>
              <label><input type="radio" name="mnlog-range" value="sd" checked> Mean ± 2 SD</label>
              <label><input type="radio" name="mnlog-range" value="observed"> Observed min/max</label>
              <label><input type="radio" name="mnlog-range" value="custom"> Custom</label>
              <div class="custom-range" id="mnlog-custom-range-wrapper" style="display:none;">
                <label>Min <input type="number" id="mnlog-range-min" step="any"></label>
                <label>Max <input type="number" id="mnlog-range-max" step="any"></label>
              </div>
            </div>
            <div class="effect-constants-card">
              <h4>Hold other predictors constant</h4>
              <p class="hint">
                Choose levels/values for the non-focal predictors used when plotting the focal curve.
              </p>
              <div id="mnlog-nonfocal-continuous" class="effect-nonfocal-levels"></div>
              <div id="mnlog-nonfocal-categorical" class="effect-nonfocal-levels"></div>
            </div>
            <div class="chart-placeholder" id="chart-a"></div>
            <p id="mnlog-effect-note" class="chart-note">
              After you upload data, choose an outcome, select at least one predictor (with at least one continuous predictor to see the line view), and run the model, this chart will show how the predicted probability of each outcome changes with the focal predictor while holding others constant.
            </p>
            <details class="interpretation-aid">
              <summary>Interpretation Aid</summary>
              <p class="muted">
                The line (or bars for categorical focals) shows the predicted probability of each outcome category while holding other predictors constant at chosen values. Steeper slopes or larger gaps between bars imply stronger effects. Confidence bands/bars reflect the statistical uncertainty for those probabilities; wider bands mean less certainty. If bands for different categories overlap heavily, the model may not distinguish them well at those settings.
              </p>
            </details>
          </article>
          <article class="card chart-card">
            <h3>Observed vs predicted outcome distribution</h3>
            <div class="chart-placeholder" id="chart-b"></div>
            <p class="chart-note">
              This bar chart compares how often each outcome category appears in the modeled data (observed) with the
              predicted class counts (hard classification by highest predicted probability). Use the controls below to
              switch between counts and percentages or to hide the predicted bars.
            </p>
            <details class="interpretation-aid">
              <summary>Interpretation Aid</summary>
              <p class="muted">
                Observed bars show the actual distribution. Predicted bars come from assigning each row to the outcome
                with the highest predicted probability, so counts are integer (or proportions if you toggle percentage
                view). Large gaps suggest misfit or missing predictors; close alignment means the model’s classifications
                mirror the observed mix.
              </p>
            </details>
          </article>
        </div>
      </div>
      <div class="card visual-output-settings">
        <details>
          <summary>Visual Output Settings</summary>
          <div class="visual-settings-grid">
            <label class="switch-option">
              <input type="checkbox" id="toggle-chart-mode" checked>
              <span>Show predicted distribution as well as observed</span>
            </label>
            <label>
              Y-axis scale
              <select id="visual-mode">
                <option value="rows">Counts</option>
                <option value="columns">Percent of modeled sample</option>
              </select>
            </label>
          </div>
        </details>
      </div>
    </section>

    <section class="summary-section" aria-labelledby="summary-heading">
      <h2 id="summary-heading">SUMMARY STATISTICS</h2>
      <div class="card summary-stats-card">
        <h3>Summary Statistics</h3>
        <div class="summary-stats-grid">
          <div>
            <h4>Continuous Predictors</h4>
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Variable</th>
                  <th>Mean</th>
                  <th>Median</th>
                  <th>Std. Dev.</th>
                  <th>Min</th>
                  <th>Max</th>
                </tr>
              </thead>
              <tbody id="mnlog-numeric-summary-body">
                <tr><td colspan="6">Provide data to see summary statistics.</td></tr>
              </tbody>
            </table>
          </div>
          <div>
            <h4>Categorical Predictors (% by level)</h4>
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Predictor</th>
                  <th>Level</th>
                  <th>Percent</th>
                </tr>
              </thead>
              <tbody id="mnlog-categorical-summary-body">
                <tr><td colspan="3">Provide data to see level percentages.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="test-results" aria-labelledby="test-results-heading">
      <h2 id="test-results-heading">TEST RESULTS</h2>
      <div class="card regression-equation-card">
        <h3>Regression Equation</h3>
        <details class="interpretation-aid">
          <summary>Show regression equations</summary>
          <p id="mnlog-regression-equation" class="regression-equation-text">
            Run the model to view the fitted log-odds equations for each outcome contrast.
          </p>
        </details>
      </div>
      <div class="card metrics-panel">
        <div class="metric-output">Model log-likelihood: <span id="statistic-value">&ndash;</span></div>
        <div class="metric-output">Approx. degrees of freedom: <span id="df-value">&ndash;</span></div>
        <div class="metric-output">p-value (not computed): <span id="p-value">&ndash;</span></div>
        <div class="metric-output">Pseudo-R&sup2; (McFadden): <span id="effect-size">&ndash;</span></div>
        <details class="interpretation-aid">
          <summary>Interpretation Aid</summary>
          <p class="muted"><strong>Log-likelihood:</strong> Higher (less negative) is better fit; values are comparable only across models on the same data.</p>
          <p class="muted"><strong>Degrees of freedom:</strong> Rough count of free parameters ((K-1) × predictors); larger models risk overfitting with small samples.</p>
          <p class="muted"><strong>Pseudo-R²:</strong> McFadden’s measure of improvement over a null model; use for relative comparison, not literal percent variance explained.</p>
        </details>
      </div>
      <div class="dual-panels">
        <article class="card dual-panel">
          <h3>APA-Style Report</h3>
          <p id="apa-report">Placeholder APA narrative will appear here.</p>
        </article>
        <article class="card dual-panel">
          <h3>Managerial Interpretation</h3>
          <p id="managerial-report">Business-focused copy referencing scenario inputs appears here.</p>
        </article>
      </div>
      <div class="card summary-table-card">
        <h3>Coefficient Table (log-odds relative to reference outcome)</h3>
        <table class="summary-table">
          <thead>
            <tr>
              <th>Outcome contrast</th>
              <th>Predictor term</th>
              <th>Coefficient (log-odds)</th>
              <th>Std. Error</th>
              <th>p-value</th>
              <th>95% CI</th>
            </tr>
          </thead>
          <tbody id="mnlog-coefficient-table-body">
            <tr>
              <td colspan="6">Run the model to view coefficients for each outcome category relative to the reference.</td>
            </tr>
          </tbody>
        </table>
        <details class="interpretation-aid">
          <summary>Interpretation Aid</summary>
          <div id="mnlog-coef-interpretation" class="muted">
            Coefficients are log-odds relative to the reference outcome. Exponentiating a coefficient gives an odds ratio for that contrast. Large standard errors or very wide CIs indicate unstable estimates (often due to sparse categories or collinearity).
          </div>
        </details>
        <p class="template-download">
          <button type="button" id="mnlog-download-results" class="secondary">
            Download predicted probabilities (CSV)
          </button>
        </p>
        <p class="hint">
          This download exports the original uploaded data plus one column for the most likely outcome category and one
          column per outcome with its predicted probability from the fitted multinomial model.
        </p>
      </div>
    </section>

    <section class="diagnostics-section" aria-labelledby="diagnostics-heading">
      <h2 id="diagnostics-heading">DIAGNOSTICS &amp; ASSUMPTIONS</h2>
      <div class="card">
        <details class="diagnostics-details">
          <summary>Diagnostics &amp; Assumption Tests</summary>
          <div id="diagnostics-content">
            <p>Explain assumption checks (sample size, variance, normality, expected counts, leverage points). Populate via JS.</p>
          </div>
        </details>
      </div>
    </section>
  </main>

    <footer class="app-footer">
    <p class="page-timestamps">Created: <span id="created-date">YYYY-MM-DD</span> &middot; Last updated: <span id="modified-date">YYYY-MM-DD</span></p>
      <p><a href="../../index.html">Back to Stat Analysis Selection</a></p>
      <p class="citation">Cite as: Baker, Andrew. (2025). Multinomial Logistic Regression Tool. Marketing Bivariate Tools.</p>
    </footer>

  <div id="mnlog-loading-overlay" class="loading-overlay" aria-hidden="true">
    <div class="loading-content">
      <p><strong>Fitting multinomial model…</strong></p>
      <p class="muted">For larger datasets this may take a few seconds. Please wait.</p>
    </div>
  </div>

  <script src="../../shared/js/csv_utils.js"></script>
  <script src="../../shared/js/ui_utils.js"></script>
  <script src="mn_log_model.js"></script>
  <script src="main_mn_log_regression.js"></script>
</body>

</html>
