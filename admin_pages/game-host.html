<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Game - Marketing Analytics Tools</title>
    <link rel="stylesheet" href="../shared/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        .admin-nav {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }
        .admin-nav-links {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        .admin-nav-links a {
            color: #4f46e5;
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .admin-nav-links a:hover {
            background: #eef2ff;
            color: #4338ca;
        }
        .admin-nav-links a.active {
            background: #4f46e5;
            color: white;
        }
        .logout-btn {
            margin-left: auto;
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .logout-btn:hover {
            background: #b91c1c;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .host-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .host-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            margin-bottom: 2rem;
        }
        .room-code-display {
            padding: 2rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 12px;
            color: white;
            margin: 1rem 0;
        }
        .room-code-display h1 {
            font-size: 4rem;
            letter-spacing: 0.2em;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .room-code-display p {
            margin: 0;
            opacity: 0.9;
        }
        .room-code-display .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .room-code-display .code-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        .copy-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        .copy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .copy-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.35);
        }
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .qr-code-container #qrcode {
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
        }
        .qr-code-container p {
            color: #1e293b;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0;
        }
        .game-status {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .status-card {
            flex: 1;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            text-align: center;
        }
        .status-card h3 {
            color: #64748b;
            font-size: 0.875rem;
            margin: 0 0 0.5rem 0;
            text-transform: uppercase;
            font-weight: 600;
        }
        .status-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        .question-panel, .players-panel {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .panel-header h2 {
            margin: 0;
            color: #1e293b;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #334155;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .players-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8fafc;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .player-item:hover {
            background: #e2e8f0;
        }
        .player-name {
            font-weight: 600;
            color: #1e293b;
        }
        .player-status {
            font-size: 0.875rem;
            color: #64748b;
        }
        .player-status.connected {
            color: #10b981;
        }
        .player-status.disconnected {
            color: #ef4444;
        }
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .alert-info {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
        .control-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .control-buttons .btn {
            flex: 1;
        }
        .game-config {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        .game-config strong {
            color: #1e293b;
        }
        .status-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 1rem;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 600;
        }
        .status-waiting {
            background: rgba(147,197,253,0.2);
            color: #1d4ed8;
        }
        .status-in_progress {
            background: rgba(110,231,183,0.2);
            color: #047857;
        }
        .status-paused {
            background: rgba(253,224,71,0.2);
            color: #b45309;
        }
        .status-completed, .status-cancelled {
            background: rgba(248,113,113,0.2);
            color: #b91c1c;
        }
        .connection-pill {
            margin-top: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.9rem;
            background: rgba(148,163,184,0.2);
            color: #334155;
            border: 1px solid rgba(148,163,184,0.5);
        }
        .connection-pill.connected {
            background: rgba(74,222,128,0.15);
            color: #0f766e;
            border-color: rgba(16,185,129,0.4);
        }
        .connection-pill.connecting {
            background: rgba(253,224,71,0.15);
            color: #b45309;
            border-color: rgba(234,179,8,0.4);
        }
        .connection-pill.disconnected {
            background: rgba(248,113,113,0.15);
            color: #b91c1c;
            border-color: rgba(248,113,113,0.4);
        }
        .player-meta {
            display: flex;
            flex-direction: column;
            font-size: 0.85rem;
            color: #475569;
        }
        .player-badges {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-top: 0.25rem;
        }
        .player-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            background: #e2e8f0;
            color: #0f172a;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .player-badge.waiting {
            background: rgba(248,250,252,0.8);
            color: #b45309;
            border: 1px solid rgba(249,115,22,0.4);
        }
        .player-badge.late {
            background: rgba(199,210,254,0.5);
            color: #3730a3;
        }
        .player-score {
            font-weight: 700;
            color: #1e293b;
        }
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10000;
        }
        .toast {
            min-width: 220px;
            background: #0f172a;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(15,23,42,0.35);
            animation: fadeIn 0.2s ease, fadeOut 0.2s ease 3.5s forwards;
        }
        .toast.success {
            background: #047857;
        }
        .toast.error {
            background: #b91c1c;
        }
        .toast.warning {
            background: #b45309;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(10px);}
            to {opacity: 1; transform: translateY(0);}
        }
        @keyframes fadeOut {
            to {opacity: 0; transform: translateY(-10px);}
        }
    </style>
</head>
<body>
    <nav class="admin-nav">
        <div class="admin-nav-links">
            <a href="admin-dashboard.html">üìä System Dashboard</a>
            <a href="instructor.html">üë®‚Äçüè´ Course Management</a>
            <a href="instructor-analytics.html">üìà Course Analytics</a>
            <a href="quiz.html">üìù Quiz Editor</a>
            <a href="game-host.html" class="active">üéÆ Game Host</a>
            <a href="student-dashboard.html">üë§ Student View</a>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </nav>
    <div class="host-container">
        <div class="host-header">
            <div class="room-code-display">
                <div class="info-row">
                    <p style="margin: 0;">Students join at: <span id="joinLinkDisplay">https://drbakermarketing.com/admin_pages/game-join.html</span></p>
                    <button class="copy-btn" id="copyJoinLinkBtn">Copy Link</button>
                </div>
                <div class="code-row">
                    <h1 id="roomCodeDisplay">----</h1>
                    <button class="copy-btn" id="copyRoomCodeBtn" disabled>Copy Code</button>
                </div>
                <p style="margin-top: 0.5rem;">Room Code</p>
                
                <!-- QR Code -->
                <div class="qr-code-container" id="qrCodeContainer" style="display: none;">
                    <div id="qrcode"></div>
                    <p>üì± Scan to join game</p>
                </div>
            </div>
            
            <div class="game-status">
                <div class="status-card">
                    <h3>Status</h3>
                    <div class="value"><span id="gameStatus" class="status-chip status-waiting">Waiting</span></div>
                </div>
                <div class="status-card">
                    <h3>Players</h3>
                    <div class="value" id="playerCount">0</div>
                </div>
                <div class="status-card">
                    <h3>Game Type</h3>
                    <div class="value" id="gameType">-</div>
                </div>
            </div>
            <div class="connection-pill" id="connectionStatus">WS: Idle</div>
        </div>

        <div class="main-content">
            <div class="question-panel">
                <div class="panel-header">
                    <h2>Game Setup</h2>
                </div>

                <div id="setupSection">
                    <!-- Header -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #1e293b;">üéØ Multi-Round Game Setup</h3>
                        <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Select a pre-built template with multiple questions for cumulative scoring</p>
                    </div>

                    <!-- Quick Start Button -->
                    <div class="alert alert-info" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                        <strong>üöÄ Quick Start:</strong> Want to test the game system? Load 5 sample questions instantly!
                        <button class="btn" id="quickStartBtn" style="background: white; color: #059669; font-weight: 600; margin-top: 0.5rem; width: 100%;">
                            ‚ö° Load Sample Questions
                        </button>
                    </div>

                    <div style="text-align: center; margin: 1rem 0; color: #6b7280;">
                        ‚Äî OR ‚Äî
                    </div>

                    <!-- Quick 1-Round Template -->
                    <button class="btn" id="quickOneRoundBtn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; width: 100%; margin-bottom: 1.5rem; font-weight: 600;">
                        ‚ö° Quick 1-Round Template
                    </button>

                    <div style="text-align: center; margin: 1rem 0; color: #6b7280;">
                        ‚Äî OR create multi-round games ‚Äî
                    </div>

                    <!-- Template Mode -->
                    <div id="templateMode">
                        <div class="alert alert-info">
                            <strong>üéØ Multi-Round Templates:</strong> Select a pre-built template with multiple questions. Students play through all questions in order, with cumulative scoring!
                            <a href="game-template-builder.html" style="color: white; font-weight: 700; text-decoration: underline; display: block; margin-top: 0.5rem;">
                                ‚ûï Create New Template
                            </a>
                        </div>

                        <div class="form-group">
                            <label for="templateSelect">Select Template</label>
                            <select id="templateSelect" required>
                                <option value="">Loading templates...</option>
                            </select>
                        </div>

                        <div id="templatePreview" style="display: none; padding: 1rem; background: #f8fafc; border-radius: 8px; margin-top: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #1e293b;">Template Details:</h4>
                            <div id="templateDetails"></div>
                        </div>

                        <!-- Advanced Settings Panel -->
                        <div id="advancedSettings" style="margin-top: 1.5rem; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                            <button id="advancedToggle" onclick="toggleAdvancedSettings()" style="width: 100%; padding: 0.75rem; background: #f8fafc; border: none; text-align: left; font-weight: 600; color: #475569; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span>‚öôÔ∏è Advanced Settings (Optional)</span>
                                <span id="advancedToggleIcon">‚ñº</span>
                            </button>
                            <div id="advancedSettingsContent" style="display: none; padding: 1rem; background: white;">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="timeOverride" style="font-size: 0.875rem; font-weight: 600; color: #475569;">‚è±Ô∏è Time Limit Override (seconds)</label>
                                    <input type="number" id="timeOverride" placeholder="Leave empty to use question default" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" min="5" max="600">
                                    <small style="color: #6b7280; font-size: 0.75rem;">Override the default time limit for all questions</small>
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="scoringMultiplier" style="font-size: 0.875rem; font-weight: 600; color: #475569;">üéØ Scoring Multiplier</label>
                                    <select id="scoringMultiplier" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="0.5">0.5x (Half Points)</option>
                                        <option value="1" selected>1x (Normal)</option>
                                        <option value="1.5">1.5x (Bonus)</option>
                                        <option value="2">2x (Double Points)</option>
                                        <option value="3">3x (Triple Points)</option>
                                    </select>
                                    <small style="color: #6b7280; font-size: 0.75rem;">Multiply all points by this factor</small>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="leaderboardVisibility" style="font-size: 0.875rem; font-weight: 600; color: #475569;">üìä Leaderboard Visibility</label>
                                    <select id="leaderboardVisibility" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="always_show" selected>Always Show</option>
                                        <option value="hide_during_show_end">Hide During Round, Show at End</option>
                                        <option value="always_hide">Always Hide</option>
                                    </select>
                                    <small style="color: #6b7280; font-size: 0.75rem;">Control when students see the leaderboard</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="guestPassword">Guest Password (optional)</label>
                        <input type="password" id="guestPassword" placeholder="Leave empty to allow anyone">
                    </div>

                    <div class="alert alert-info">
                        <strong>üìã Instructions:</strong> Select a course and game type, then choose a question. Once students join, click "Start Game" to begin!
                    </div>

                    <button class="btn btn-primary" id="createGameBtn" style="width: 100%;">
                        Create Game Session
                    </button>
                </div>

                <div id="gameSection" style="display: none;">
                    <div id="countdownOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; flex-direction: column;">
                        <div id="countdownNumber" style="font-size: 120px; font-weight: bold; color: #3b82f6; text-shadow: 0 0 30px rgba(59, 130, 246, 0.8);"></div>
                        <div id="countdownRoundInfo" style="font-size: 24px; color: white; margin-top: 20px;"></div>
                    </div>
                    <div id="questionDisplay"></div>
                    <div class="game-config" id="gameConfig"></div>
                    
                    <div class="control-buttons">
                        <button class="btn btn-primary" id="startGameBtn">
                            ‚ñ∂Ô∏è Start Game
                        </button>
                        <button class="btn btn-primary" id="nextRoundBtn" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            ‚è≠Ô∏è Next Round
                        </button>
                        <button class="btn btn-danger" id="endGameBtn">
                            ‚èπÔ∏è End Game
                        </button>
                    </div>
                </div>
            </div>

            <div class="players-panel">
                <div class="panel-header">
                    <h2>Players</h2>
                    <span id="playerCountBadge" style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 600;">0</span>
                </div>

                <div id="playersListContainer">
                    <div class="alert alert-warning">
                        No players yet. Share the room code with your students!
                    </div>
                </div>

                <div class="players-list" id="playersList"></div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script>
        const API_BASE = 'https://drbaker-backend.onrender.com/api';
        const WS_BASE = 'wss://drbaker-backend.onrender.com';
        const JOIN_URL = 'https://drbakermarketing.com/admin_pages/game-join.html';
        
        let gameSession = null;
        let websocket = null;
        let reconnectTimeout = null;
        let hasShownConnectionToast = false;
        let isManualWebsocketClose = false;
        let currentRoomCode = '';
        let currentLeaderboard = [];
        let token = localStorage.getItem('auth_token');
        
        const toastContainer = document.getElementById('toastContainer');
        const statusChipEl = document.getElementById('gameStatus');
        const connectionStatusEl = document.getElementById('connectionStatus');
        const copyRoomCodeBtn = document.getElementById('copyRoomCodeBtn');
        
        if (!token) {
            alert('Please log in first');
            window.location.href = 'login.html';
        }

        const STATUS_LABELS = {
            waiting: 'Waiting',
            in_progress: 'In Progress',
            paused: 'Paused',
            completed: 'Completed',
            cancelled: 'Cancelled'
        };

        function showToast(message, type = 'info') {
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3800);
        }

        function copyTextToClipboard(text, successMessage) {
            if (!navigator.clipboard) {
                showToast('Clipboard not supported', 'error');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                if (successMessage) showToast(successMessage, 'success');
            }).catch(() => showToast('Copy failed', 'error'));
        }

        function updateRoomCodeDisplay(code) {
            currentRoomCode = code || '';
            document.getElementById('roomCodeDisplay').textContent = currentRoomCode || '----';
            if (copyRoomCodeBtn) {
                copyRoomCodeBtn.disabled = !currentRoomCode;
            }
            
            // Generate QR code for the game join link
            const qrContainer = document.getElementById('qrCodeContainer');
            const qrCodeDiv = document.getElementById('qrcode');
            
            if (currentRoomCode) {
                // Clear any existing QR code
                qrCodeDiv.innerHTML = '';
                
                // Generate join URL with room code pre-filled
                const joinUrl = `https://drbakermarketing.com/admin_pages/game-join.html?room=${currentRoomCode}`;
                
                // Create QR code
                new QRCode(qrCodeDiv, {
                    text: joinUrl,
                    width: 180,
                    height: 180,
                    colorDark: "#1e293b",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                // Show QR container
                qrContainer.style.display = 'flex';
            } else {
                // Hide QR container when no room code
                qrContainer.style.display = 'none';
                qrCodeDiv.innerHTML = '';
            }
        }

        function setStatusIndicator(statusKey, labelOverride) {
            if (!statusChipEl) return;
            const classList = ['status-chip'];
            if (statusKey && STATUS_LABELS[statusKey]) {
                classList.push(`status-${statusKey}`);
            }
            statusChipEl.className = classList.join(' ');
            statusChipEl.textContent = labelOverride || STATUS_LABELS[statusKey] || statusKey || 'Unknown';
        }

        function setConnectionStatus(state, labelOverride) {
            if (!connectionStatusEl) return;
            connectionStatusEl.className = `connection-pill ${state || ''}`;
            const labels = {
                connected: 'WS: Connected',
                connecting: 'WS: Connecting‚Ä¶',
                disconnected: 'WS: Disconnected'
            };
            connectionStatusEl.textContent = labelOverride || labels[state] || 'WS: Idle';
        }

        document.getElementById('joinLinkDisplay').textContent = JOIN_URL;
        updateRoomCodeDisplay(null);
        setStatusIndicator('waiting');
        setConnectionStatus();

        document.getElementById('copyJoinLinkBtn')?.addEventListener('click', () => {
            copyTextToClipboard(JOIN_URL, 'Join link copied');
        });

        copyRoomCodeBtn?.addEventListener('click', () => {
            if (!currentRoomCode) {
                showToast('Create a game to generate a code', 'warning');
                return;
            }
            copyTextToClipboard(currentRoomCode, 'Room code copied');
        });

        // Show template warning dialog when some questions are missing
        function showTemplateWarningDialog(data) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);';
                modal.innerHTML = `
                    <h2 style="margin: 0 0 1rem 0; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                        ‚ö†Ô∏è Template Issue Detected
                    </h2>
                    <p style="color: #1e293b; margin-bottom: 1rem;">${data.message}</p>
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="margin-bottom: 0.5rem;"><strong>Template:</strong> ${data.template_name}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Valid Questions:</strong> ${data.valid_count} of ${data.total_questions}</div>
                        <div><strong>Missing Question IDs:</strong> ${data.missing_question_ids.join(', ')}</div>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.9rem;">
                        ${data.can_proceed 
                            ? 'You can proceed with the remaining questions, or rebuild the template with only the valid questions.' 
                            : 'This template has no valid questions remaining. Please rebuild it.'}
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        ${data.can_proceed ? `
                            <button id="proceedBtn" style="flex: 1; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ‚úì Proceed with ${data.valid_count} Questions
                            </button>
                        ` : ''}
                        <button id="rebuildBtn" style="flex: 1; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîß Rebuild Template
                        </button>
                        <button id="cancelBtn" style="padding: 0.75rem 1.5rem; background: #e2e8f0; color: #475569; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                // Event listeners
                if (data.can_proceed) {
                    modal.querySelector('#proceedBtn').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                        resolve('force');
                    });
                }
                modal.querySelector('#rebuildBtn').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve('rebuild');
                });
                modal.querySelector('#cancelBtn').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve('cancel');
                });
            });
        }

        // Load courses
        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE}/courses/`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                const courses = await response.json();
                
                const select = document.getElementById('courseSelect');
                select.innerHTML = '<option value="">Select a course...</option>';
                courses.forEach(course => {
                    select.innerHTML += `<option value="${course.id}">${course.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Load game templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/game/templates/`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                const templates = await response.json();
                
                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">Select a template...</option>';
                templates.forEach(template => {
                    const universalBadge = template.is_universal ? ' üåê' : '';
                    const cloneAttr = template.is_universal ? ` data-is-universal="true"` : '';
                    select.innerHTML += `<option value="${template.id}"${cloneAttr}>${template.name}${universalBadge} (${template.question_count} questions)</option>`;
                });
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templateSelect').innerHTML = '<option value="">Error loading templates</option>';
            }
        }

        // Clone template function
        async function cloneTemplate(templateId, templateName) {
            const newName = prompt(`Clone "${templateName}"\n\nEnter a name for your copy:`, `${templateName} (My Copy)`);
            if (!newName) return;
            
            try {
                const response = await fetch(`${API_BASE}/game/templates/${templateId}/clone/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });
                
                if (!response.ok) throw new Error('Clone failed');
                
                const data = await response.json();
                showToast(`Template cloned: ${newName}`, 'success');
                await loadTemplates();
                
                // Select the newly cloned template
                document.getElementById('templateSelect').value = data.template.id;
                document.getElementById('templateSelect').dispatchEvent(new Event('change'));
            } catch (error) {
                console.error('Error cloning template:', error);
                showToast('Failed to clone template', 'error');
            }
        }

        // Toggle advanced settings panel
        function toggleAdvancedSettings() {
            const content = document.getElementById('advancedSettingsContent');
            const icon = document.getElementById('advancedToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // Show template preview
        document.getElementById('templateSelect')?.addEventListener('change', async function() {
            const templateId = this.value;
            const preview = document.getElementById('templatePreview');
            
            if (!templateId) {
                preview.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/game/templates/${templateId}/`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                const template = await response.json();
                const questionCount = template.question_count || 0;
                const estimatedSeconds = questionCount * 30;
                const estimatedMinutes = questionCount ? Math.max(1, Math.round(estimatedSeconds / 60)) : 0;
                const estimateDisplay = estimatedMinutes ? `~${estimatedMinutes} minute${estimatedMinutes === 1 ? '' : 's'}` : 'N/A';
                const sampleQuestionList = (template.question_ids || []).slice(0, 5).join(', ');
                const descriptionBlock = template.description ? `
                    <div style="margin-top: 0.5rem; color: #475569;">${template.description}</div>
                ` : '';
                
                const universalBadge = template.is_universal ? '<span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">üåê Universal</span>' : '';
                const cloneButton = template.is_universal ? `<button onclick="cloneTemplate(${template.id}, '${template.name.replace(/'/g, "\\'")}')"; style="background: #8b5cf6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 0.75rem;">üìã Clone to Customize</button>` : '';
                
                document.getElementById('templateDetails').innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.5rem; align-items: center;">
                        <div><strong>Name:</strong> ${template.name}${universalBadge}</div>
                        <div><strong>Rounds:</strong> ${questionCount}</div>
                        <div><strong>Created by:</strong> ${template.created_by_username || 'Unknown'}</div>
                    </div>
                    <div style="margin-bottom: 0.3rem;"><strong>Estimated Time:</strong> ${estimateDisplay}</div>
                    <div style="margin-bottom: 0.3rem;"><strong>Question IDs:</strong> ${sampleQuestionList || 'Not available'}</div>
                    <div style="color: #6b7280; font-size: 0.875rem;">Students will play through all ${questionCount} questions with cumulative scoring.</div>
                    ${descriptionBlock}
                    ${cloneButton}
                `;
                preview.style.display = 'block';
                showToast(`Loaded template "${template.name}"`, 'success');
            } catch (error) {
                console.error('Error loading template details:', error);
                showToast('Failed to load template details', 'error');
            }
        });

        // Quick Start with Sample Questions
        document.getElementById('quickStartBtn').addEventListener('click', async function() {
            alert('üéÆ Sample Questions Feature\n\n' +
                  'To use sample questions:\n\n' +
                  '1. The system includes 5 pre-made Speed Tap questions\n' +
                  '2. The system includes 5 pre-made Closest Guess questions\n' +
                  '3. These are available in any course you select\n\n' +
                  'Simply:\n' +
                  '‚úÖ Select your course\n' +
                  '‚úÖ Choose Speed Tap or Closest Guess\n' +
                  '‚úÖ Look for sample questions in the dropdown\n\n' +
                  'Sample questions cover general knowledge topics like:\n' +
                  '- Geography (capitals, oceans)\n' +
                  '- Science (planets, temperature, human body)\n' +
                  '- Math (calculations, measurements)');
        });

        // Quick 1-Round Template - auto-creates template from selected question
        document.getElementById('quickOneRoundBtn').addEventListener('click', async function() {
            // Show modal to select question
            const gameType = prompt('Quick 1-Round Template\n\nSelect game type:\n1 = Speed Tap\n2 = Closest Guess\n3 = Push Range', '1');
            if (!gameType) return;
            
            let gameTypeStr;
            switch(gameType) {
                case '1': gameTypeStr = 'speed_tap'; break;
                case '2': gameTypeStr = 'closest_guess'; break;
                case '3': gameTypeStr = 'push_range'; break;
                default:
                    alert('Invalid game type');
                    return;
            }
            
            try {
                // Fetch questions for this game type
                const response = await fetch(`${API_BASE}/game/questions/?game_type=${gameTypeStr}`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                const questions = await response.json();
                
                if (questions.length === 0) {
                    alert('No questions found for this game type. Please create questions first.');
                    return;
                }
                
                // Show question selection
                let questionList = 'Select a question (enter number):\n\n';
                questions.slice(0, 10).forEach((q, i) => {
                    const preview = q.question_text.substring(0, 60) + (q.question_text.length > 60 ? '...' : '');
                    questionList += `${i + 1}. ${preview}\n`;
                });
                
                const selection = prompt(questionList, '1');
                if (!selection) return;
                
                const selectedIndex = parseInt(selection) - 1;
                if (selectedIndex < 0 || selectedIndex >= questions.length) {
                    alert('Invalid selection');
                    return;
                }
                
                const selectedQuestion = questions[selectedIndex];
                
                // Create template with single question
                const templateName = `Quick: ${selectedQuestion.question_text.substring(0, 40)}...`;
                const createResponse = await fetch(`${API_BASE}/game/templates/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: templateName,
                        description: 'Quick 1-round game',
                        question_ids: [selectedQuestion.id]
                    })
                });
                
                if (!createResponse.ok) throw new Error('Failed to create template');
                
                const newTemplate = await createResponse.json();
                showToast('Quick template created!', 'success');
                
                // Reload templates and select the new one
                await loadTemplates();
                document.getElementById('templateSelect').value = newTemplate.id;
                document.getElementById('templateSelect').dispatchEvent(new Event('change'));
                
            } catch (error) {
                console.error('Error creating quick template:', error);
                showToast('Failed to create quick template', 'error');
            }
        });

        // Create game session
        document.getElementById('createGameBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            const guestPassword = document.getElementById('guestPassword').value;
            const templateId = document.getElementById('templateSelect').value;
            
            if (!templateId) {
                alert('Please select a template');
                return;
            }
            
            // Build game_settings object from advanced settings
            const gameSettings = {};
            
            const timeOverride = document.getElementById('timeOverride').value;
            if (timeOverride) {
                gameSettings.time_limit_override = parseInt(timeOverride);
            }
            
            const scoringMultiplier = parseFloat(document.getElementById('scoringMultiplier').value);
            if (scoringMultiplier !== 1.0) {
                gameSettings.scoring_multiplier = scoringMultiplier;
            }
            
            const leaderboardVisibility = document.getElementById('leaderboardVisibility').value;
            if (leaderboardVisibility !== 'always_show') {
                gameSettings.leaderboard_visibility = leaderboardVisibility;
            }
            
            const requestBody = {
                game_template_id: parseInt(templateId),
                guest_password: guestPassword,
                game_settings: Object.keys(gameSettings).length > 0 ? gameSettings : null
            };
            
            try {
                const response = await fetch(`${API_BASE}/game/create/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const responseData = await response.json();
                
                // Handle template validation warning (some questions missing)
                if (response.status === 409 && responseData.warning) {
                    const proceed = await showTemplateWarningDialog(responseData);
                    if (proceed === 'force') {
                        // User wants to proceed with valid questions only
                        requestBody.force = true;
                        const retryResponse = await fetch(`${API_BASE}/game/create/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        if (!retryResponse.ok) {
                            throw new Error('Failed to create game');
                        }
                        gameSession = await retryResponse.json();
                    } else if (proceed === 'rebuild') {
                        // User wants to rebuild - redirect to template builder with valid questions
                        const validIds = responseData.valid_question_ids.join(',');
                        window.location.href = `game-template-builder.html?prefill=${validIds}&template_id=${responseData.template_id}`;
                        return;
                    } else {
                        // User cancelled
                        return;
                    }
                } else if (!response.ok) {
                    throw new Error(responseData.error || 'Failed to create game');
                } else {
                    gameSession = responseData;
                }
                
                // Update UI
                updateRoomCodeDisplay(gameSession.room_code);
                document.getElementById('gameType').textContent = gameSession.game_type || (gameSession.total_rounds > 1 ? 'Multi-Round' : '-');
                setStatusIndicator(gameSession.status);
                showToast('Game session created', 'success');
                
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('gameSection').style.display = 'block';
                
                // Display question or template info
                if (gameSession.total_rounds > 1) {
                    // Multi-round template
                    document.getElementById('questionDisplay').innerHTML = `
                        <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>üéØ Multi-Round Game:</strong><br>
                            ${gameSession.total_rounds} questions total<br>
                            Click "Start Game" to begin Round 1!
                        </div>
                    `;
                } else {
                    // Single question
                    document.getElementById('questionDisplay').innerHTML = `
                        <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>Question:</strong><br>
                            ${gameSession.question_text}
                        </div>
                    `;
                }
                
                // Display game config
                if (gameSession.game_config) {
                    let configHTML = '<strong>Game Settings:</strong><br>';
                    if (gameSession.game_time_limit) {
                        configHTML += `‚è±Ô∏è Time Limit: ${gameSession.game_time_limit}s<br>`;
                    }
                    if (gameSession.game_config.max_range_width) {
                        configHTML += `üìè Max Range Width: ${gameSession.game_config.max_range_width}<br>`;
                    }
                    if (gameSession.total_rounds > 1) {
                        configHTML += `üîÑ Rounds: ${gameSession.current_round} / ${gameSession.total_rounds}<br>`;
                    }
                    document.getElementById('gameConfig').innerHTML = configHTML;
                }
                
                // Connect to WebSocket
                connectWebSocket(gameSession.room_code);
                
                // Start polling for player updates
                pollPlayers();
                
            } catch (error) {
                showToast(error.message || 'Error creating game', 'error');
                alert('Error creating game: ' + error.message);
            }
        });

        // Start game
        document.getElementById('startGameBtn').addEventListener('click', async function() {
            if (!gameSession) return;
            
            // Get current player count
            const playerCountBadge = document.getElementById('playerCountBadge');
            const playerCount = parseInt(playerCountBadge.textContent) || 0;
            
            // Validate player count
            if (playerCount === 0) {
                alert('‚ö†Ô∏è Cannot start game with 0 players!\n\nPlease wait for at least one student to join before starting.');
                return;
            }
            
            if (playerCount === 1) {
                const confirmed = confirm('‚ö†Ô∏è Only 1 player has joined\n\nStarting a game with only one player is allowed, but the competitive experience works best with multiple players.\n\nDo you want to start anyway?');
                if (!confirmed) return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/game/${gameSession.room_code}/start/`, {
                    method: 'POST',
                    headers: {'Authorization': `Token ${token}`}
                });
                
                if (!response.ok) throw new Error('Failed to start game');
                
                gameSession = await response.json();
                setStatusIndicator('in_progress');
                showToast('Game started', 'success');
                
                // Game started successfully - WebSocket will receive broadcast from server
                this.disabled = true;
            } catch (error) {
                showToast(error.message || 'Error starting game', 'error');
                alert('Error starting game: ' + error.message);
            }
        });

        // End game
        document.getElementById('endGameBtn').addEventListener('click', async function() {
            if (!gameSession) return;
            
            if (!confirm('Are you sure you want to end the game?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/game/${gameSession.room_code}/end/`, {
                    method: 'POST',
                    headers: {'Authorization': `Token ${token}`}
                });
                
                if (!response.ok) throw new Error('Failed to end game');
                
                gameSession = await response.json();
                setStatusIndicator('completed');
                showToast('Game ended', 'warning');
                
                this.disabled = true;
                document.getElementById('startGameBtn').disabled = true;
                document.getElementById('nextRoundBtn').style.display = 'none';
            } catch (error) {
                showToast(error.message || 'Error ending game', 'error');
                alert('Error ending game: ' + error.message);
            }
        });

        // Next Round button
        document.getElementById('nextRoundBtn').addEventListener('click', async function() {
            if (!gameSession) return;
            
            console.log('Next Round button clicked');
            const nextBtn = this;
            nextBtn.disabled = true;
            nextBtn.textContent = 'Advancing...';
            
            try {
                const response = await fetch(`${API_BASE}/game/${gameSession.room_code}/advance-round/`, {
                    method: 'POST',
                    headers: {'Authorization': `Token ${token}`}
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to advance round');
                }
                
                gameSession = await response.json();
                console.log('Round advanced, new gameSession:', gameSession);
                
                showToast(`Advanced to Round ${gameSession.current_round}`, 'success');
                setStatusIndicator('paused', `Round ${gameSession.current_round} Ready`);
                // Update UI with new round number
                document.getElementById('gameConfig').innerHTML = `
                    <strong>Round ${gameSession.current_round} of ${gameSession.total_rounds}</strong><br>
                    Status: Paused - Ready to start Round ${gameSession.current_round}
                `;
                
                // Hide Next Round button, show Start Game button
                nextBtn.style.display = 'none';
                const startBtn = document.getElementById('startGameBtn');
                startBtn.style.display = 'inline-block';
                startBtn.disabled = false;
                startBtn.textContent = '‚ñ∂Ô∏è Start Round ' + gameSession.current_round;
                
                console.log('UI updated - Start Game button shown, Next Round button hidden');
                
            } catch (error) {
                console.error('Error advancing round:', error);
                showToast(error.message || 'Error advancing round', 'error');
                alert('Error advancing round: ' + error.message);
                nextBtn.disabled = false;
                nextBtn.textContent = '‚è≠Ô∏è Next Round';
            }
        });
        
        // Handle game ended event from WebSocket
        function handleGameEnded(message) {
            console.log('Game ended event received:', message);
            
            // Use message data directly since it's most up-to-date
            const totalRounds = message.total_rounds || (gameSession ? gameSession.total_rounds : 1);
            const currentRound = message.current_round || (gameSession ? gameSession.current_round : 1);
            const isMultiRound = totalRounds > 1;
            const hasMoreRounds = isMultiRound && currentRound < totalRounds;
            
            console.log(`Multi-round check: total=${totalRounds}, current=${currentRound}, hasMore=${hasMoreRounds}`);
            
            if (hasMoreRounds) {
                // Show Next Round button
                document.getElementById('startGameBtn').style.display = 'none';
                const nextBtn = document.getElementById('nextRoundBtn');
                nextBtn.style.display = 'inline-block';
                nextBtn.disabled = false;
                setStatusIndicator('paused', `Round ${currentRound} Complete - Ready for Next Round`);
                showToast(`Round ${currentRound} complete`, 'info');
            } else {
                // Final round complete - show end-of-game UI
                setStatusIndicator('completed', 'Game Over!');
                showToast('Game over! üéâ', 'success');
                document.getElementById('startGameBtn').disabled = true;
                document.getElementById('nextRoundBtn').style.display = 'none';

                // Build Game Over overlay
                const overlay = document.createElement('div');
                overlay.id = 'gameOverOverlay';
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100vw';
                overlay.style.height = '100vh';
                overlay.style.background = 'rgba(30,41,59,0.92)';
                overlay.style.zIndex = '9999';
                overlay.style.display = 'flex';
                overlay.style.flexDirection = 'column';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';

                // Banner
                const banner = document.createElement('h1');
                banner.textContent = 'üéâ Game Over!';
                banner.style.color = '#10b981';
                banner.style.fontSize = '3rem';
                banner.style.marginBottom = '2rem';
                overlay.appendChild(banner);

                // Leaderboard
                const leaderboard = document.createElement('div');
                leaderboard.style.background = 'white';
                leaderboard.style.borderRadius = '16px';
                leaderboard.style.padding = '2rem';
                leaderboard.style.boxShadow = '0 8px 32px rgba(0,0,0,0.15)';
                leaderboard.style.marginBottom = '2rem';
                leaderboard.style.minWidth = '350px';

                // Use stored leaderboard from separate leaderboard_update message
                const finalLeaderboard = message.leaderboard || currentLeaderboard;
                
                leaderboard.innerHTML = `<h2 style="color:#3b82f6; text-align:center; margin-bottom:1rem;">üèÜ Final Leaderboard</h2>`;
                if (finalLeaderboard && finalLeaderboard.length > 0) {
                    leaderboard.innerHTML += '<ol style="font-size:1.25rem;">' +
                        finalLeaderboard.map((player, idx) => {
                            const isWinner = idx === 0;
                            const playerName = player.player_name || player.display_name || player.name || 'Unknown';
                            return `<li style="margin-bottom:0.5rem;${isWinner ? 'font-weight:800;color:#10b981;' : ''}">
                                ${isWinner ? 'üèÜ ' : ''}${playerName} <span style="color:#64748b; font-size:1rem;">(${player.score} pts)</span>
                            </li>`;
                        }).join('') + '</ol>';
                } else {
                    leaderboard.innerHTML += '<p>No scores available.</p>';
                }
                overlay.appendChild(leaderboard);

                // Summary stats
                const stats = document.createElement('div');
                stats.style.background = '#f8fafc';
                stats.style.borderRadius = '12px';
                stats.style.padding = '1.5rem';
                stats.style.marginBottom = '2rem';
                stats.style.textAlign = 'center';
                stats.innerHTML = `<h3 style="color:#475569;">Summary Stats</h3>
                    <div>Rounds Played: <strong>${totalRounds}</strong></div>
                    <div>Players: <strong>${finalLeaderboard ? finalLeaderboard.length : 0}</strong></div>
                    ${message.fastest_response ? `<div>Fastest Response: <strong>${message.fastest_response.player_name || message.fastest_response.display_name || message.fastest_response.name}</strong> (${message.fastest_response.time_ms} ms)</div>` : ''}
                `;
                overlay.appendChild(stats);

                // Action buttons
                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '1rem';
                actions.style.marginBottom = '2rem';

                // Rematch button
                const rematchBtn = document.createElement('button');
                rematchBtn.className = 'btn btn-primary';
                rematchBtn.textContent = 'üîÑ Rematch';
                rematchBtn.onclick = () => window.location.reload();
                actions.appendChild(rematchBtn);

                // Export button
                const exportBtn = document.createElement('button');
                exportBtn.className = 'btn';
                exportBtn.textContent = 'üìÑ Export Results';
                exportBtn.onclick = () => {
                    // Simple CSV export
                    if (finalLeaderboard && finalLeaderboard.length > 0) {
                        const csv = 'Rank,Name,Score\n' + finalLeaderboard.map((p, i) => {
                            const playerName = p.player_name || p.display_name || p.name || 'Unknown';
                            return `${i+1},"${playerName}",${p.score}`;
                        }).join('\n');
                        const blob = new Blob([csv], {type: 'text/csv'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'game_results.csv';
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast('Results exported', 'success');
                    } else {
                        showToast('No leaderboard data to export', 'warning');
                    }
                };
                actions.appendChild(exportBtn);

                // Share button
                const shareBtn = document.createElement('button');
                shareBtn.className = 'btn';
                shareBtn.textContent = 'üîó Share Summary';
                shareBtn.onclick = () => {
                    const winner = finalLeaderboard && finalLeaderboard[0];
                    const winnerName = winner ? (winner.player_name || winner.display_name || winner.name || 'N/A') : 'N/A';
                    const winnerScore = winner ? winner.score : '';
                    const summary = `Game Over! Winner: ${winnerName}${winnerScore ? ` (${winnerScore} pts)` : ''}`;
                    navigator.clipboard.writeText(summary).then(() => {
                        shareBtn.textContent = '‚úÖ Copied!';
                        setTimeout(() => shareBtn.textContent = 'üîó Share Summary', 2000);
                    }).catch(() => {
                        showToast('Failed to copy to clipboard', 'error');
                    });
                };
                actions.appendChild(shareBtn);

                // Dashboard button
                const dashBtn = document.createElement('button');
                dashBtn.className = 'btn';
                dashBtn.textContent = 'üè† Return to Dashboard';
                dashBtn.onclick = () => window.location.href = '/admin_pages/instructor.html';
                actions.appendChild(dashBtn);

                overlay.appendChild(actions);

                document.body.appendChild(overlay);
            }
        }
        
        // Handle round changed event from WebSocket
        function handleRoundChanged(message) {
            if (gameSession) {
                gameSession.current_round = message.current_round;
                gameSession.total_rounds = message.total_rounds;
            }
            setStatusIndicator('paused', `Round ${message.current_round} Ready`);
            showToast(`Round ${message.current_round} is ready`, 'info');
        }
        
        // Handle countdown event from WebSocket
        async function handleCountdownStart(message) {
            const overlay = document.getElementById('countdownOverlay');
            const numberDiv = document.getElementById('countdownNumber');
            const roundInfo = document.getElementById('countdownRoundInfo');
            
             setStatusIndicator('in_progress', `Starting Round ${message.current_round}...`);
            // Show overlay
            overlay.style.display = 'flex';
            roundInfo.textContent = `Round ${message.current_round} of ${message.total_rounds}`;
            
            // Countdown: 3, 2, 1
            for (let count = 3; count >= 1; count--) {
                numberDiv.textContent = count;
                numberDiv.style.color = '#3b82f6';
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Show GO!
            numberDiv.textContent = 'GO!';
            numberDiv.style.color = '#10b981';
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Hide overlay
            overlay.style.display = 'none';
            numberDiv.style.color = '#3b82f6';
            
            // Now trigger the actual game start
            // The game_data is embedded in the countdown_start message
            if (message.game_data) {
                // This would normally be handled by game_started event
                // but since we're doing countdown client-side, we handle it here
                console.log('Game starting after countdown:', message.game_data);
            }
        }

        // WebSocket connection
        function connectWebSocket(roomCode) {
            if (!roomCode) return;
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            setConnectionStatus('connecting');
            if (websocket) {
                try {
                    isManualWebsocketClose = true;
                    websocket.close();
                } catch (e) {
                    console.warn('Error closing existing websocket', e);
                }
            }
            websocket = new WebSocket(`${WS_BASE}/ws/game/${roomCode}/`);
            isManualWebsocketClose = false;
            
            websocket.onopen = function() {
                console.log('WebSocket connected');
                setConnectionStatus('connected');
                if (!hasShownConnectionToast) {
                    showToast('Live updates connected', 'success');
                    hasShownConnectionToast = true;
                }
            };
            
            websocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                console.log('WebSocket message:', message);
                
                if (message.type === 'player_list_update') {
                    updatePlayersList(message.players);
                } else if (message.type === 'leaderboard_update') {
                    currentLeaderboard = message.leaderboard || [];
                    console.log('Leaderboard updated:', currentLeaderboard);
                } else if (message.type === 'game_ended') {
                    handleGameEnded(message);
                } else if (message.type === 'round_changed') {
                    handleRoundChanged(message);
                } else if (message.type === 'countdown_start') {
                    handleCountdownStart(message);
                }
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                showToast('Live connection error', 'error');
            };
            
            websocket.onclose = function() {
                console.log('WebSocket closed');
                setConnectionStatus('disconnected');
                websocket = null;
                const shouldReconnect = !isManualWebsocketClose && gameSession && !['completed', 'cancelled'].includes(gameSession.status || '');
                isManualWebsocketClose = false;
                if (shouldReconnect) {
                    showToast('Connection lost, retrying...', 'warning');
                    reconnectTimeout = setTimeout(() => connectWebSocket(roomCode), 3000);
                    setConnectionStatus('connecting', 'WS: Reconnecting‚Ä¶');
                }
            };
        }

        // Poll for player updates
        async function pollPlayers() {
            if (!gameSession) return;
            
            try {
                const response = await fetch(`${API_BASE}/game/${gameSession.room_code}/`);
                const data = await response.json();
                
                document.getElementById('playerCount').textContent = data.player_count;
                document.getElementById('playerCountBadge').textContent = data.player_count;
                
                updatePlayersList(data.players || []);
                
                // Poll again if game is active
                if (data.status !== 'completed' && data.status !== 'cancelled') {
                    setTimeout(pollPlayers, 3000);
                }
            } catch (error) {
                console.error('Error polling players:', error);
            }
        }

        // Update players list
        function updatePlayersList(players = []) {
            const container = document.getElementById('playersListContainer');
            const list = document.getElementById('playersList');
            
            if (!Array.isArray(players) || players.length === 0) {
                container.style.display = 'block';
                list.innerHTML = '';
                return;
            }
            
            container.style.display = 'none';
            list.innerHTML = players.map(player => {
                const badges = [];
                if (player.joined_mid_game) badges.push('<span class="player-badge late">Late Join</span>');
                if (player.waiting_to_enter) badges.push('<span class="player-badge waiting">Waiting</span>');
                const badgeRow = badges.length ? `<div class="player-badges">${badges.join('')}</div>` : '';
                const score = typeof player.score === 'number' ? player.score : 0;
                const rank = player.rank || '‚Äî';
                const extraInfo = player.joined_at_round ? `First round: ${player.joined_at_round}` : '';
                return `
                <div class="player-item">
                    <div>
                        <span class="player-name">${player.display_name || player.name}</span>
                        <div class="player-meta">
                            <span class="player-score">Score: ${score}</span>
                            <span>Rank: ${rank}${extraInfo ? ' ‚Ä¢ ' + extraInfo : ''}</span>
                        </div>
                        ${badgeRow}
                    </div>
                    <span class="player-status ${player.is_connected ? 'connected' : 'disconnected'}">
                        ${player.is_connected ? 'üü¢ Online' : 'üî¥ Offline'}
                    </span>
                </div>
                `;
            }).join('');
        }

        // Initialize
        loadCourses();
        loadTemplates();
        
        // Logout function
        function handleLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
