<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Bank - Dr. Baker Marketing</title>
    <link rel="icon" type="image/svg+xml" href="../../art_assets/svg_logos/clr_notext_logo.svg">
    <link rel="stylesheet" href="../../shared/css/main.css">
    <script src="../../shared/js/tracking.js"></script>
    <link rel="stylesheet" href="../../shared/css/admin-nav.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for previews -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SortableJS for drag and drop previews -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.75rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .search-bar input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .question-grid {
            display: grid;
            gap: 1rem;
        }

        .question-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .question-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-multiple_choice { background: #dbeafe; color: #1e40af; }
        .type-select_all { background: #fef3c7; color: #92400e; }
        .type-numeric { background: #d1fae5; color: #065f46; }
        .type-fill_blank { background: #e9d5ff; color: #6b21a8; }
        .type-written { background: #fce7f3; color: #9f1239; }
        .type-reorder { background: #fbcfe8; color: #831843; }
        .type-matching { background: #fed7aa; color: #92400e; }

        .difficulty-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .diff-easy { background: #d1fae5; color: #065f46; }
        .diff-medium { background: #fef3c7; color: #92400e; }
        .diff-hard { background: #fee2e2; color: #991b1b; }

        .question-text {
            font-size: 1rem;
            color: var(--gray-900);
            margin: 1rem 0;
            line-height: 1.5;
        }

        .question-meta {
            display: flex;
            gap: 1.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .question-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .question-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Modal Styles - Shared with Question Editor */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--gray-900);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-700);
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="url"],
        .form-group input[type="color"],
        .form-group select,
        .form-group textarea,
        .option-item input[type="text"],
        .option-item input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .option-list {
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            padding: 1rem;
            background: var(--gray-50);
        }

        .option-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .option-item input[type="text"] {
            flex: 1;
        }

        .option-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .option-item button {
            padding: 0.5rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-option-btn {
            margin-top: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-700);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--gray-200);
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--gray-700);
        }

        .spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .tag {
            background: var(--gray-100);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--gray-700);
        }

        /* Quiz Builder Panel */
        .quiz-builder-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: 1rem 2rem;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 900;
        }

        .quiz-builder-panel.active {
            display: flex;
        }

        .selection-count {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .question-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="admin-nav-container"></div>
    <script src="../shared/js/admin-nav.js"></script>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-question-circle"></i> Question Bank</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='quiz-manager.html'">
                    <i class="fas fa-arrow-left"></i> Back to Quizzes
                </button>
                <button class="btn btn-primary" onclick="showCreateModal()">
                    <i class="fas fa-plus"></i> Create Question
                </button>
            </div>
        </div>

        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Question Type</label>
                    <select id="filterType" onchange="applyFilters()">
                        <option value="">All Types</option>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="select_all">Select All</option>
                        <option value="numeric">Numeric</option>
                        <option value="fill_blank">Fill in Blank</option>
                        <option value="written">Written</option>
                        <option value="reorder">Reorder</option>
                        <option value="matching">Matching</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Difficulty</label>
                    <select id="filterDifficulty" onchange="applyFilters()">
                        <option value="">All Levels</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tool/Topic</label>
                    <select id="filterTool" onchange="applyFilters()">
                        <option value="">All Tools</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Visibility</label>
                    <select id="filterVisibility" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="private">Private</option>
                        <option value="shared">Shared</option>
                        <option value="universal">Universal</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortBy" onchange="applyFilters()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="difficulty_asc">Difficulty (Easy-Hard)</option>
                        <option value="difficulty_desc">Difficulty (Hard-Easy)</option>
                        <option value="type">Type</option>
                    </select>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search questions..." onkeyup="handleSearch()">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>

        <div id="questionsList" class="question-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading questions...</p>
            </div>
        </div>
    </div>

    <!-- Quiz Builder Panel -->
    <div id="quizBuilderPanel" class="quiz-builder-panel">
        <div class="selection-info">
            <span id="selectionCount" class="selection-count">0 questions selected</span>
            <span style="color: var(--gray-700); margin-left: 1rem;">Select questions to build a quiz</span>
        </div>
        <div class="panel-actions">
            <button class="btn btn-secondary" onclick="clearSelection()">
                Clear Selection
            </button>
            <button class="btn btn-primary" onclick="createQuizFromSelection()">
                <i class="fas fa-magic"></i> Create Quiz from Selected
            </button>
        </div>
    </div>

    <!-- Shared Question Editor Container -->
    <div id="question-editor-container"></div>

    <script src="../../shared/js/auth_tracking.js"></script>
    <script src="../../shared/js/question-editor.js"></script>
    <script>
        // API_BASE is defined in auth_tracking.js
        let allQuestions = [];
        let selectedQuestions = new Set();

        // Auth
        function getToken() {
            return localStorage.getItem('auth_token');
        }

        function checkAuth() {
            if (!getToken()) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return;
            
            // Configure Shared Editor
            window.QuestionEditorConfig = {
                quizId: null, // No quiz ID for question bank
                onSaveSuccess: async () => {
                    await loadQuestions();
                }
            };

            // Load Shared Editor HTML
            try {
                const response = await fetch('../../shared/components/question-editor-modal.html');
                if (response.ok) {
                    const html = await response.text();
                    document.getElementById('question-editor-container').innerHTML = html;
                } else {
                    console.error('Failed to load question editor component');
                }
            } catch (e) {
                console.error('Error loading question editor component:', e);
            }

            await loadTools();
            await loadQuestions();
        });

        // Load tools for filter and form
        async function loadTools() {
            try {
                const response = await fetch(`${API_BASE}/tools/`, {
                    headers: { 'Authorization': `Token ${getToken()}` }
                });
                const tools = await response.json();
                
                const filterSelect = document.getElementById('filterTool');
                
                tools.forEach(tool => {
                    filterSelect.innerHTML += `<option value="${tool.slug}">${tool.name}</option>`;
                });
                
                // Store tools for later use when modal opens
                window.availableTools = tools;
                
            } catch (error) {
                console.error('Error loading tools:', error);
            }
        }
        
        const sharedShowCreateModal = window.showCreateModal;
        window.showCreateModal = function() {
            populateToolSelect();
            if (sharedShowCreateModal) sharedShowCreateModal();
        };
        
        const sharedEditQuestion = window.editQuestion;
        window.editQuestion = function(id) {
            populateToolSelect();
            if (sharedEditQuestion) sharedEditQuestion(id);
        };
        
        function populateToolSelect() {
            const formSelect = document.getElementById('tool');
            if (formSelect && window.availableTools && formSelect.options.length <= 1) {
                window.availableTools.forEach(tool => {
                    // Check if option already exists
                    if (!formSelect.querySelector(`option[value="${tool.id}"]`)) {
                        formSelect.innerHTML += `<option value="${tool.id}">${tool.name}</option>`;
                    }
                });
            }
        }

        // Load questions
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE}/quiz-questions/`, {
                    headers: { 'Authorization': `Token ${getToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load questions');
                
                allQuestions = await response.json();
                displayQuestions(allQuestions);
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('questionsList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Error Loading Questions</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Display questions
        function displayQuestions(questions) {
            const container = document.getElementById('questionsList');
            const currentUser = getCurrentUsername();
            const isStaffUser = isStaff();
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-question-circle"></i>
                        <h3>No Questions Found</h3>
                        <p>Create your first question to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = questions.map(q => {
                // Support both old and new ownership fields (backward compatible)
                const owner = q.content_owner || q.created_by;
                const canEdit = isStaffUser || (owner && owner.username === currentUser);
                
                return `
                <div class="question-card">
                    <div class="question-header">
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" class="question-checkbox" 
                                value="${q.id}" 
                                ${selectedQuestions.has(q.id.toString()) ? 'checked' : ''}
                                onchange="toggleSelection('${q.id}')">
                            <div>
                                <span class="question-type-badge type-${q.question_type}">
                                    ${formatQuestionType(q.question_type)}
                                </span>
                                ${q.difficulty ? `<span class="difficulty-badge diff-${q.difficulty}">${q.difficulty}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="question-text">${q.question_text}</div>
                    
                    ${q.tags && q.tags.length > 0 ? `
                        <div class="tags">
                            ${q.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="question-meta">
                        ${q.tool ? `
                            <div class="question-meta-item">
                                <i class="fas fa-wrench"></i>
                                ${q.tool.name}
                            </div>
                        ` : ''}
                        <div class="question-meta-item">
                            <i class="fas fa-eye"></i>
                            ${q.visibility}
                        </div>
                        ${(q.content_owner || q.created_by) ? `
                            <div class="question-meta-item">
                                <i class="fas fa-user"></i>
                                ${(q.content_owner || q.created_by).username}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="question-actions">
                        <button class="btn btn-sm btn-primary" onclick="previewQuestion(${q.id})">
                            <i class="fas fa-play"></i> Preview
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="viewQuestion(${q.id})">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="copyQuestion(${q.id})">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        ${canEdit ? `
                            <button class="btn btn-sm btn-secondary" onclick="editQuestion(${q.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="deleteQuestion(${q.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // Selection Logic
        function toggleSelection(id) {
            id = id.toString();
            if (selectedQuestions.has(id)) {
                selectedQuestions.delete(id);
            } else {
                selectedQuestions.add(id);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const panel = document.getElementById('quizBuilderPanel');
            const countSpan = document.getElementById('selectionCount');
            const count = selectedQuestions.size;
            
            countSpan.textContent = `${count} question${count !== 1 ? 's' : ''} selected`;
            
            if (count > 0) {
                panel.classList.add('active');
            } else {
                panel.classList.remove('active');
            }
        }

        function clearSelection() {
            selectedQuestions.clear();
            updateSelectionUI();
            // Re-render to uncheck boxes
            applyFilters(); 
        }

        async function createQuizFromSelection() {
            if (selectedQuestions.size === 0) return;
            
            const title = prompt('Enter a title for the new quiz:');
            if (!title) return;

            // Determine tool_id
            let toolId = null;
            const questionIds = Array.from(selectedQuestions);
            
            // Try to get tool from first selected question
            const firstQ = allQuestions.find(q => q.id == questionIds[0]);
            if (firstQ && firstQ.tool && firstQ.tool.id) {
                toolId = firstQ.tool.id;
            } 
            // Fallback to first available tool
            else if (window.availableTools && window.availableTools.length > 0) {
                toolId = window.availableTools[0].id;
            }

            // Tool ID is now optional
            
            try {
                // 1. Create Quiz
                const createRes = await fetch(`${API_BASE}/quiz/manage/create/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        description: 'Created from Question Bank selection',
                        is_active: false,
                        time_limit_minutes: 30,
                        tool_id: toolId
                    })
                });
                
                if (!createRes.ok) {
                    const err = await createRes.json();
                    throw new Error(err.error || 'Failed to create quiz');
                }
                const quiz = await createRes.json();
                
                // 2. Add Questions
                let addedCount = 0;
                
                // Show progress
                const btn = document.querySelector('#quizBuilderPanel .btn-primary');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                btn.disabled = true;
                
                for (const qId of questionIds) {
                    await fetch(`${API_BASE}/quiz/${quiz.id}/questions/add/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question_id: parseInt(qId),
                            order: addedCount + 1,
                            points: 1
                        })
                    });
                    addedCount++;
                }
                
                // 3. Redirect
                window.location.href = `quiz-questions.html?quiz_id=${quiz.id}`;
                
            } catch (error) {
                console.error('Error creating quiz:', error);
                alert('Failed to create quiz: ' + error.message);
                
                // Reset button
                const btn = document.querySelector('#quizBuilderPanel .btn-primary');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-magic"></i> Create Quiz from Selected';
                    btn.disabled = false;
                }
            }
        }

        async function copyQuestion(id) {
            if (!confirm('Create a copy of this question?')) return;
            
            try {
                // 1. Get original question data
                const getRes = await fetch(`${API_BASE}/quiz-questions/${id}/`, {
                    headers: { 'Authorization': `Token ${getToken()}` }
                });
                if (!getRes.ok) throw new Error('Failed to fetch question');
                const original = await getRes.json();
                
                // 2. Prepare new data
                const newData = {
                    ...original,
                    question_text: original.question_text + ' (Copy)',
                    visibility: 'private' // Default to private for copies
                };
                delete newData.id; // Remove ID to create new
                delete newData.created_by; // Backend handles this (legacy)
                delete newData.content_owner; // Backend handles this
                delete newData.original_creator; // Backend handles this
                delete newData.created_at;
                delete newData.updated_at;
                
                // 3. Create new question
                const createRes = await fetch(`${API_BASE}/quiz-questions/create/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newData)
                });
                
                if (!createRes.ok) throw new Error('Failed to create copy');
                
                // 4. Refresh
                await loadQuestions();
                alert('Question copied successfully!');
                
            } catch (error) {
                console.error('Error copying question:', error);
                alert('Failed to copy question: ' + error.message);
            }
        }

        // Format question type for display
        function formatQuestionType(type) {
            const types = {
                'multiple_choice': 'Multiple Choice',
                'select_all': 'Select All',
                'numeric': 'Numeric',
                'fill_blank': 'Fill Blank',
                'written': 'Written',
                'reorder': 'Reorder',
                'matching': 'Matching'
            };
            return types[type] || type;
        }

        // Filters
        function applyFilters() {
            const type = document.getElementById('filterType').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            const tool = document.getElementById('filterTool').value;
            const visibility = document.getElementById('filterVisibility').value;
            const sortBy = document.getElementById('sortBy').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allQuestions.filter(q => {
                if (type && q.question_type !== type) return false;
                if (difficulty && q.difficulty !== difficulty) return false;
                if (tool && (!q.tool || q.tool.slug !== tool)) return false;
                if (visibility && q.visibility !== visibility) return false;
                if (search) {
                    const searchable = `${q.question_text} ${q.instruction} ${q.tags.join(' ')}`.toLowerCase();
                    if (!searchable.includes(search)) return false;
                }
                return true;
            });

            // Sorting
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'newest':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'oldest':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'difficulty_asc':
                        const diffMap = { 'easy': 1, 'medium': 2, 'hard': 3 };
                        return (diffMap[a.difficulty] || 0) - (diffMap[b.difficulty] || 0);
                    case 'difficulty_desc':
                        const diffMapDesc = { 'easy': 1, 'medium': 2, 'hard': 3 };
                        return (diffMapDesc[b.difficulty] || 0) - (diffMapDesc[a.difficulty] || 0);
                    case 'type':
                        return a.question_type.localeCompare(b.question_type);
                    default:
                        return 0;
                }
            });

            displayQuestions(filtered);
        }

        function handleSearch() {
            if (event.key === 'Enter') {
                applyFilters();
            }
        }

        async function viewQuestion(id) {
            try {
                const [questionRes, analyticsRes] = await Promise.all([
                    fetch(`${API_BASE}/quiz-questions/${id}/`, {
                        headers: { 'Authorization': `Token ${getToken()}` }
                    }),
                    fetch(`${API_BASE}/quiz-analytics/question/${id}/`, {
                        headers: { 'Authorization': `Token ${getToken()}` }
                    })
                ]);

                if (!questionRes.ok) throw new Error('Failed to load question');
                
                const question = await questionRes.json();
                const analytics = analyticsRes.ok ? await analyticsRes.json() : null;

                showQuestionDetailsModal(question, analytics);
            } catch (error) {
                console.error('Error loading question:', error);
                alert('Failed to load question details');
            }
        }

        function showQuestionDetailsModal(question, analytics) {
            const hasAnalytics = analytics && analytics.times_answered > 0;
            
            let analyticsHTML = '';
            if (hasAnalytics) {
                const performanceClass = 
                    analytics.correct_rate >= 70 ? 'success' : 
                    analytics.correct_rate >= 50 ? 'warning' : 'danger';
                
                const difficultyMatch = analytics.difficulty_match;
                const matchBadge = difficultyMatch ? 
                    '<span class="badge badge-success">✓ Difficulty Matches</span>' :
                    `<span class="badge badge-warning">⚠ Difficulty Mismatch (Actual: ${analytics.actual_difficulty})</span>`;

                analyticsHTML = `
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--gray-200);">
                        <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-bar"></i> Performance Analytics</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">Times Used</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${analytics.times_used}</div>
                            </div>
                            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">Times Answered</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${analytics.times_answered}</div>
                            </div>
                            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">Correct Rate</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--${performanceClass});">${analytics.correct_rate.toFixed(1)}%</div>
                            </div>
                            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">Avg Points</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${analytics.average_points.toFixed(1)}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            ${matchBadge}
                        </div>

                        ${analytics.response_distribution ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="margin-bottom: 0.75rem;">Response Distribution</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #d1fae5; border-radius: 4px;">
                                        <span><i class="fas fa-check-circle" style="color: #065f46;"></i> Correct</span>
                                        <strong>${analytics.times_correct} (${((analytics.times_correct/analytics.times_answered)*100).toFixed(1)}%)</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #fee2e2; border-radius: 4px;">
                                        <span><i class="fas fa-times-circle" style="color: #991b1b;"></i> Incorrect</span>
                                        <strong>${analytics.times_incorrect} (${((analytics.times_incorrect/analytics.times_answered)*100).toFixed(1)}%)</strong>
                                    </div>
                                    ${analytics.times_partial > 0 ? `
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                                        <span><i class="fas fa-minus-circle" style="color: #92400e;"></i> Partial</span>
                                        <strong>${analytics.times_partial} (${((analytics.times_partial/analytics.times_answered)*100).toFixed(1)}%)</strong>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${analytics.recommendations && analytics.recommendations.length > 0 ? `
                            <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary);">
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);"><i class="fas fa-lightbulb"></i> Recommendations</h4>
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    ${analytics.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <div style="margin-top: 1rem;">
                            <button class="btn btn-sm btn-secondary" onclick="refreshQuestionAnalytics(${question.id})">
                                <i class="fas fa-sync-alt"></i> Refresh Analytics
                            </button>
                        </div>
                    </div>
                `;
            } else {
                analyticsHTML = `
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--gray-200); text-align: center; color: var(--gray-700);">
                        <i class="fas fa-chart-bar" style="font-size: 2rem; color: var(--gray-200); margin-bottom: 1rem;"></i>
                        <p>No performance data yet. This question hasn't been answered by students.</p>
                    </div>
                `;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'viewQuestionModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2><i class="fas fa-eye"></i> Question Details</h2>
                        <button class="btn btn-secondary" onclick="closeViewModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <span class="badge badge-info">${question.question_type.replace('_', ' ')}</span>
                                <span class="badge badge-${question.difficulty === 'hard' ? 'danger' : question.difficulty === 'medium' ? 'warning' : 'success'}">${question.difficulty}</span>
                                ${question.tool ? `<span class="badge badge-info">${question.tool}</span>` : ''}
                                <span class="badge badge-info">${question.visibility}</span>
                                <span class="badge badge-secondary" title="Edit Count"><i class="fas fa-pen"></i> ${question.edit_count || 0}</span>
                            </div>
                            
                            <h3 style="margin-bottom: 1rem;">${question.question_text}</h3>
                            
                            ${question.instruction ? `<p style="color: var(--gray-700); font-style: italic; margin-bottom: 1rem;">${question.instruction}</p>` : ''}
                            
                            ${question.image_url ? `<img src="${question.image_url}" style="max-width: 100%; border-radius: 8px; margin-bottom: 1rem;" alt="Question image">` : ''}
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem;">Answer Configuration</h4>
                            <pre style="background: var(--gray-50); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.875rem;">${JSON.stringify(question.answer_config, null, 2)}</pre>
                        </div>

                        ${question.feedback_correct ? `
                            <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <strong style="color: #065f46;"><i class="fas fa-check-circle"></i> Correct Feedback:</strong>
                                <p style="margin: 0.5rem 0 0 0;">${question.feedback_correct}</p>
                            </div>
                        ` : ''}

                        ${question.feedback_incorrect ? `
                            <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <strong style="color: #991b1b;"><i class="fas fa-times-circle"></i> Incorrect Feedback:</strong>
                                <p style="margin: 0.5rem 0 0 0;">${question.feedback_incorrect}</p>
                            </div>
                        ` : ''}

                        ${question.tags && question.tags.length > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Tags:</strong>
                                ${question.tags.map(tag => `<span class="badge badge-secondary" style="margin-left: 0.5rem;">${tag}</span>`).join('')}
                            </div>
                        ` : ''}

                        ${analyticsHTML}

                        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeViewModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                            <button class="btn btn-primary" onclick="closeViewModal(); editQuestion(${question.id});">
                                <i class="fas fa-edit"></i> Edit Question
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeViewModal() {
            const modal = document.getElementById('viewQuestionModal');
            if (modal) {
                modal.remove();
            }
        }

        async function refreshQuestionAnalytics(questionId) {
            try {
                const response = await fetch(`${API_BASE}/quiz-analytics/question/${questionId}/refresh/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Token ${getToken()}` }
                });

                if (!response.ok) throw new Error('Failed to refresh analytics');

                alert('Analytics refreshed successfully!');
                closeViewModal();
                viewQuestion(questionId); // Reload the view
            } catch (error) {
                console.error('Error refreshing analytics:', error);
                alert('Failed to refresh analytics');
            }
        }

        async function previewQuestion(id) {
            try {
                const response = await fetch(`${API_BASE}/quiz-questions/${id}/`, {
                    headers: { 'Authorization': `Token ${getToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load question');
                
                const question = await response.json();
                
                // Create a temporary modal for preview
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '2000';
                
                // Render the question content
                let contentHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-play"></i> Question Preview</h2>
                            <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="preview-banner" style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; color: #1e40af;">
                                <i class="fas fa-info-circle"></i> This is how the question will appear to students.
                            </div>
                            
                            <div class="question-card" style="box-shadow: none; border: 1px solid #e5e7eb;">
                                <div class="question-text" style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                                    ${question.question_text}
                                </div>
                                
                                ${renderPreviewInputs(question)}
                            </div>
                            
                            ${question.explanation ? `
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
                                    <h4 style="color: #166534; margin-top: 0;"><i class="fas fa-lightbulb"></i> Explanation (Shown after submission)</h4>
                                    <div style="color: #15803d;">${question.explanation}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close Preview</button>
                        </div>
                    </div>
                `;
                
                modal.innerHTML = contentHTML;
                document.body.appendChild(modal);
                
                // Render charts if any
                if (question.answer_config && question.answer_config.charts) {
                    const chartContainer = document.createElement('div');
                    chartContainer.id = 'preview-charts-container';
                    chartContainer.style.marginBottom = '1.5rem';
                    
                    // Insert before question text
                    const qText = modal.querySelector('.question-text');
                    qText.parentNode.insertBefore(chartContainer, qText);
                    
                    // Basic chart rendering for preview
                    Object.entries(question.answer_config.charts).forEach(([chartId, chartConfig]) => {
                        const canvas = document.createElement('canvas');
                        canvas.id = `chart-${chartId}`;
                        canvas.style.maxHeight = '300px';
                        canvas.style.width = '100%';
                        chartContainer.appendChild(canvas);
                        
                        // Simple bar chart using Chart.js (assuming it's loaded)
                        if (window.Chart) {
                            new Chart(canvas, {
                                type: chartConfig.type || 'bar',
                                data: {
                                    labels: chartConfig.labels || ['A', 'B', 'C'],
                                    datasets: [{
                                        label: chartConfig.title || 'Chart',
                                        data: chartConfig.data || [10, 20, 30],
                                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                        borderColor: 'rgb(59, 130, 246)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: chartConfig.title || 'Chart Preview'
                                        }
                                    }
                                }
                            });
                        } else {
                            chartContainer.innerHTML = '<div class="alert alert-warning">Chart.js not loaded - cannot preview chart</div>';
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error previewing question:', error);
                alert('Failed to load preview');
            }
        }
    </script>
</body>
</html>