<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Dashboard - Marketing Analytics Tools</title>
    <link rel="stylesheet" href="../shared/css/main.css">
    <link rel="stylesheet" href="../shared/css/admin-nav.css">
    <style>
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        .dashboard-card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .dashboard-card h3 {
            margin-top: 0;
            color: #1f2937;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 0.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .message {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        .message.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .message.success {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }
        .course-list {
            list-style: none;
            padding: 0;
        }
        .course-item {
            background: #f9fafb;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .course-item h4 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }
        .course-item p {
            margin: 0.25rem 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        .code-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .code-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
            font-family: monospace;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .code-badge.used {
            background: #f3f4f6;
            color: #9ca3af;
            text-decoration: line-through;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-box {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        .stat-box .number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
        }
        .stat-box .label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            overflow: auto;
        }
        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 8px;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .close {
            font-size: 2rem;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            border: none;
            background: none;
        }
        .close:hover {
            color: #4b5563;
        }
        .code-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .code-table th,
        .code-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .code-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        .code-table tr:hover {
            background-color: #f9fafb;
        }
        .badge-used {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-available {
            background: #d1fae5;
            color: #059669;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-expired {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-inactive {
            background: #f3f4f6;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin-left: 0.25rem;
        }
        .btn-danger {
            background: #dc2626;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-success {
            background: #059669;
        }
        .btn-success:hover {
            background: #047857;
        }
    </style>
</head>
<body>
    <!-- Admin Navigation (loaded dynamically) -->
    <div id="admin-nav-container"></div>
    <script src="../shared/js/admin-nav.js"></script>
    
    <div class="dashboard-container">
        <header class="intro hero-header">
            <div class="hero-header__top">
                <h1>Instructor Dashboard</h1>
                <div class="hero-context">
                    <span class="badge">Course Management</span>
                </div>
            </div>
            <p class="hero-header__lede">
                Create courses, generate registration codes, and monitor student usage.
            </p>
        </header>

        <div id="access-denied" style="display: none;">
            <div class="card">
                <h2 style="color: #dc2626;">⚠️ Access Denied</h2>
                <p>You must be logged in as an instructor to access this page.</p>
                <a href="login.html" class="btn">Login</a>
            </div>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="dashboard-grid">
                <!-- Create Course Section -->
                <div class="dashboard-card">
                    <h3>Create New Course</h3>
                    <div id="create-message" class="message"></div>
                    <form id="create-course-form">
                        <div class="form-group">
                            <label for="course-name">Course Name *</label>
                            <input type="text" id="course-name" required placeholder="e.g., Marketing Analytics Fall 2025">
                        </div>
                        <div class="form-group">
                            <label for="instructor-name">Instructor Name</label>
                            <input type="text" id="instructor-name" placeholder="Your name">
                        </div>
                        <div class="form-group">
                            <label for="code-count">Number of Registration Codes *</label>
                            <input type="number" id="code-count" min="1" max="500" value="30" required>
                            <small style="color: #6b7280; font-size: 0.875rem;">Generate codes for your students (1-500)</small>
                        </div>
                        <div class="form-group">
                            <label for="expiration-days">Code Expiration (Days)</label>
                            <input type="number" id="expiration-days" min="1" value="365">
                            <small style="color: #6b7280; font-size: 0.875rem;">Codes expire after this many days (default: 365)</small>
                        </div>
                        <button type="submit" class="btn" id="create-btn">Create Course & Generate Codes</button>
                    </form>
                </div>

                <!-- Course Overview Section -->
                <div class="dashboard-card" style="grid-column: span 2;">
                    <h3>Your Courses</h3>
                    <div id="courses-loading" class="loading">Loading courses...</div>
                    <div id="courses-list" style="display: none;">
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="number" id="total-courses">0</div>
                                <div class="label">Total Courses</div>
                            </div>
                            <div class="stat-box">
                                <div class="number" id="total-students">0</div>
                                <div class="label">Total Students</div>
                            </div>
                            <div class="stat-box">
                                <div class="number" id="total-codes">0</div>
                                <div class="label">Available Codes</div>
                            </div>
                            <div class="stat-box">
                                <div class="number" id="used-codes">0</div>
                                <div class="label">Used Codes</div>
                            </div>
                        </div>
                        <ul class="course-list" id="course-items"></ul>
                    </div>
                    <div id="no-courses" style="display: none;">
                        <p style="color: #6b7280; text-align: center; padding: 2rem;">No courses yet. Create your first course above!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Management Modal -->
    <div id="codeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCourseName">Course Codes</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-message" class="message"></div>
            <table class="code-table" id="codeTable">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Status</th>
                        <th>Used By</th>
                        <th>Activated</th>
                        <th>Expires</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="codeTableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="../shared/js/auth_tracking.js"></script>
    <script>
        // API_BASE is already defined in auth_tracking.js
        
        // Check if user is authenticated and is staff
        async function checkAccess() {
            if (!isAuthenticated()) {
                document.getElementById('access-denied').style.display = 'block';
                return false;
            }

            try {
                const profile = await getUserProfile();
                // For now, allow all logged-in users. You can add is_staff check later
                document.getElementById('dashboard-content').style.display = 'block';
                loadCourses();
                return true;
            } catch (error) {
                document.getElementById('access-denied').style.display = 'block';
                return false;
            }
        }

        function handleLogout() {
            logout();
        }

        // Load all courses
        async function loadCourses() {
            const token = getAuthToken();
            const loadingEl = document.getElementById('courses-loading');
            const listEl = document.getElementById('courses-list');
            const noCoursesEl = document.getElementById('no-courses');

            try {
                const response = await fetch(`${API_BASE}/courses/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load courses');

                const courses = await response.json();
                loadingEl.style.display = 'none';

                if (courses.length === 0) {
                    noCoursesEl.style.display = 'block';
                    return;
                }

                listEl.style.display = 'block';
                displayCourses(courses);
            } catch (error) {
                console.error('Error loading courses:', error);
                loadingEl.innerHTML = `<p style="color: #dc2626;">Error loading courses: ${error.message}</p>`;
            }
        }

        // Display courses in the list
        function displayCourses(courses) {
            const itemsEl = document.getElementById('course-items');
            itemsEl.innerHTML = '';

            let totalStudents = 0;
            let totalCodes = 0;
            let usedCodes = 0;

            courses.forEach(course => {
                totalStudents += course.student_count || 0;
                totalCodes += course.available_codes || 0;
                usedCodes += course.used_codes || 0;

                const li = document.createElement('li');
                li.className = 'course-item';
                li.innerHTML = `
                    <h4>${course.name}</h4>
                    <p><strong>Instructor:</strong> ${course.instructor || 'Not specified'}</p>
                    <p><strong>Students:</strong> ${course.student_count || 0} | <strong>Available Codes:</strong> ${course.available_codes || 0} | <strong>Used Codes:</strong> ${course.used_codes || 0}</p>
                    <p><strong>Created:</strong> ${new Date(course.created_at).toLocaleDateString()}</p>
                    <div style="margin-top: 0.75rem;">
                        <button class="btn btn-secondary" onclick="viewCodes(${course.id}, '${course.name.replace(/'/g, "\\'")}')">View & Manage Codes</button>
                        <button class="btn" onclick="downloadCSV(${course.id}, '${course.name.replace(/'/g, "\\'")}')" style="margin-left: 0.5rem;">⬇ Download CSV</button>
                    </div>
                `;
                itemsEl.appendChild(li);
            });

            // Update stats
            document.getElementById('total-courses').textContent = courses.length;
            document.getElementById('total-students').textContent = totalStudents;
            document.getElementById('total-codes').textContent = totalCodes;
            document.getElementById('used-codes').textContent = usedCodes;
        }
        
        // View all codes for a course in modal
        async function viewCodes(courseId, courseName) {
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE}/courses/${courseId}/codes/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load codes');
                
                const data = await response.json();
                
                // Show modal
                document.getElementById('modalCourseName').textContent = `${courseName} - Registration Codes`;
                const tbody = document.getElementById('codeTableBody');
                tbody.innerHTML = '';
                
                data.codes.forEach(code => {
                    const now = new Date();
                    const expiresAt = code.expires_at ? new Date(code.expires_at) : null;
                    const isExpired = expiresAt && expiresAt < now;
                    
                    let statusBadge = '';
                    if (code.is_used) {
                        statusBadge = '<span class="badge-used">USED</span>';
                    } else if (!code.is_active) {
                        statusBadge = '<span class="badge-inactive">INACTIVE</span>';
                    } else if (isExpired) {
                        statusBadge = '<span class="badge-expired">EXPIRED</span>';
                    } else {
                        statusBadge = '<span class="badge-available">AVAILABLE</span>';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-family: monospace; font-weight: 600;">${code.code}</td>
                        <td>${statusBadge}</td>
                        <td>${code.used_by || '-'}</td>
                        <td>${code.used_at ? new Date(code.used_at).toLocaleString() : '-'}</td>
                        <td>${expiresAt ? expiresAt.toLocaleString() : 'Never'}</td>
                        <td>
                            ${!code.is_used ? `
                                <button class="btn btn-small" onclick="editExpiration(${code.id}, '${code.code}')">Edit Expiry</button>
                                ${code.is_active ? 
                                    `<button class="btn btn-small btn-danger" onclick="toggleCodeStatus(${code.id}, false)">Deactivate</button>` :
                                    `<button class="btn btn-small btn-success" onclick="toggleCodeStatus(${code.id}, true)">Reactivate</button>`
                                }
                            ` : '<span style="color: #9ca3af;">N/A</span>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('codeModal').style.display = 'block';
            } catch (error) {
                alert('Error loading codes: ' + error.message);
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('codeModal').style.display = 'none';
        }
        
        // Download CSV of codes
        async function downloadCSV(courseId, courseName) {
            const token = getAuthToken();
            window.location.href = `${API_BASE}/courses/${courseId}/codes/csv/?token=${token}`;
        }
        
        // Edit expiration date
        async function editExpiration(codeId, codeText) {
            const newDate = prompt(`Set new expiration date for code ${codeText}.\n\nEnter date in format: YYYY-MM-DD HH:MM\n(Example: 2025-12-31 23:59)`);
            
            if (!newDate) return;
            
            try {
                // Convert to ISO format
                const isoDate = new Date(newDate).toISOString();
                
                const token = getAuthToken();
                const response = await fetch(`${API_BASE}/registration-codes/${codeId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ expires_at: isoDate })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update expiration');
                }
                
                alert('Expiration date updated successfully!');
                // Reload the modal
                closeModal();
                // Note: You'll need to store courseId and courseName to reload
            } catch (error) {
                alert('Error updating expiration: ' + error.message);
            }
        }
        
        // Toggle code active status (deactivate/reactivate)
        async function toggleCodeStatus(codeId, activate) {
            const action = activate ? 'reactivate' : 'deactivate';
            
            if (!confirm(`Are you sure you want to ${action} this code?`)) return;
            
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE}/registration-codes/${codeId}/${action}/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Failed to ${action} code`);
                }
                
                alert(`Code ${activate ? 'reactivated' : 'deactivated'} successfully!`);
                closeModal();
                // Reload courses to refresh data
                loadCourses();
            } catch (error) {
                alert(`Error ${action}ing code: ` + error.message);
            }
        }

        // Create course with codes
        document.getElementById('create-course-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const messageEl = document.getElementById('create-message');
            const submitBtn = document.getElementById('create-btn');
            
            messageEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';

            const courseName = document.getElementById('course-name').value.trim();
            const instructorName = document.getElementById('instructor-name').value.trim();
            const codeCount = parseInt(document.getElementById('code-count').value);
            const expirationDays = parseInt(document.getElementById('expiration-days').value);

            const token = getAuthToken();

            try {
                // Create course
                const courseResponse = await fetch(`${API_BASE}/courses/create/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: courseName,
                        instructor: instructorName || getCurrentUsername(),
                        num_codes: codeCount,
                        code_expiration_days: expirationDays
                    })
                });

                if (!courseResponse.ok) {
                    const error = await courseResponse.json();
                    throw new Error(error.error || 'Failed to create course');
                }

                const result = await courseResponse.json();

                messageEl.className = 'message success';
                messageEl.textContent = `✓ Created course "${result.name}" with ${result.codes_generated} registration codes!`;
                messageEl.style.display = 'block';

                // Reset form
                document.getElementById('create-course-form').reset();

                // Reload courses
                loadCourses();

            } catch (error) {
                messageEl.className = 'message error';
                messageEl.textContent = error.message;
                messageEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Course & Generate Codes';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', checkAccess);
    </script>
</body>
</html>
