<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praxis Play Template Builder - Dr. Baker Marketing</title>
    <link rel="icon" type="image/svg+xml" href="../../art_assets/svg_logos/praxisplay_notext_logo.svg">
    <link rel="stylesheet" href="../../shared/css/main.css">
    <script src="../../shared/js/tracking.js"></script>
    <link rel="stylesheet" href="../../shared/css/admin-nav.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .builder-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .builder-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            margin-bottom: 2rem;
        }
        .builder-header h1 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
        }
        .builder-header p {
            margin: 0;
            color: #64748b;
        }
        .back-btn {
            display: inline-block;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
        }
        .back-btn:hover {
            background: #2563eb;
        }
        .mode-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e2e8f0;
            background: white;
            color: #1e293b;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #1e40af;
        }
        .mode-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .templates-list {
            display: grid;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .template-card {
            padding: 1.5rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .template-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .template-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }
        .template-card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }
        .template-card-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        .template-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .template-action-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .template-action-btn.edit {
            background: #3b82f6;
            color: white;
        }
        .template-action-btn.edit:hover {
            background: #2563eb;
        }
        .template-action-btn.copy {
            background: #10b981;
            color: white;
        }
        .template-action-btn.copy:hover {
            background: #059669;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            padding: 2rem;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .panel-header h2 {
            margin: 0;
            color: #1e293b;
            font-size: 1.5rem;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            background: #3b82f6;
            color: white;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .search-filter {
            margin-bottom: 1.5rem;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        .filter-row {
            display: flex;
            gap: 0.75rem;
        }
        .filter-row select {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
        }
        .questions-list {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .question-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .question-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .question-card.added {
            background: #dcfce7;
            border-color: #10b981;
        }
        .question-text {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        .question-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        .selected-list {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }
        .selected-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        .drag-handle {
            cursor: grab;
            color: #64748b;
            font-size: 1.5rem;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .order-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-weight: 700;
            flex-shrink: 0;
        }
        .item-content {
            flex: 1;
        }
        .item-text {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        .item-type {
            font-size: 0.875rem;
            color: #64748b;
        }
        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .remove-btn:hover {
            background: #dc2626;
        }
        .inspect-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            margin-right: 0.5rem;
        }
        .inspect-btn:hover {
            background: #2563eb;
        }
        
        /* Inspection Modal Styles */
        .inspection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .inspection-modal-content {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .inspection-modal-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inspection-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .inspection-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .inspection-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .inspection-modal-body {
            padding: 2rem;
        }
        
        .inspection-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .inspection-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .inspection-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .inspection-field {
            margin-bottom: 1rem;
        }
        
        .inspection-field-label {
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .inspection-field-value {
            color: #1e293b;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .inspection-field-value.code {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
        }
        
        .inspection-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .inspection-badge.easy {
            background: #d1fae5;
            color: #065f46;
        }
        
        .inspection-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }
        
        .inspection-badge.hard {
            background: #fecaca;
            color: #991b1b;
        }
        
        .template-form {
            padding-top: 1rem;
            border-top: 2px solid #e2e8f0;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #334155;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .alert-info {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            color: #1e40af;
        }
        .alert-success {
            background: #dcfce7;
            border: 2px solid #10b981;
            color: #065f46;
        }
        .alert-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div id="admin-nav-container"></div>
    <div class="builder-container">
        <div class="builder-header">
            <a href="game-host.html" class="back-btn">‚Üê Back to Game Host</a>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>üéØ Game Template Builder</h1>
                <div style="display: flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0.5rem 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <img src="../../art_assets/svg_logos/praxisplay_notext_logo.svg" alt="Praxis Play" style="width: 24px; height: 24px;">
                    <span style="color: white; font-weight: 600; font-size: 0.9rem;">Praxis Play Tool</span>
                </div>
            </div>
            <p>Create, edit, or copy game templates by selecting and ordering minigames from your question bank.</p>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button id="newTemplateBtn" class="mode-btn active" onclick="switchMode('new')">
                    ‚ú® New Template
                </button>
                <button id="loadTemplateBtn" class="mode-btn" onclick="switchMode('load')">
                    üìÇ Load/Edit Template
                </button>
            </div>
        </div>

        <!-- Load Template Panel (initially hidden) -->
        <div id="loadTemplatePanel" class="panel" style="display: none; margin-bottom: 2rem;">
            <div class="panel-header">
                <h2>üìÇ Load Existing Template</h2>
            </div>
            <div id="templatesList" class="templates-list"></div>
        </div>

        <div class="main-grid">
            <!-- Available Questions Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Available Questions</h2>
                    <span class="badge" id="availableCount">0</span>
                </div>

                <div class="alert alert-info">
                    Click minigames below to add them to your template. You can mix all 6 minigame types!
                </div>

                <div class="search-filter">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input" 
                        placeholder="üîç Search minigames...">
                    
                    <div class="filter-row">
                        <select id="gameTypeFilter">
                            <option value="">All Minigame Types</option>
                            <option value="speed_tap">‚ö° Speed Tap</option>
                            <option value="closest_guess">üéØ Closest Guess</option>
                            <option value="push_range">ü§úüü¶üü•ü§õ Push Range</option>
                            <option value="crowd_wisdom">üß† Crowd Wisdom</option>
                            <option value="word_guess">üî§ Word Guess</option>
                            <option value="rpg_battle">‚öîÔ∏è RPG Party Battle</option>
                        </select>
                        <select id="courseFilter">
                            <option value="">All Courses</option>
                        </select>
                    </div>
                </div>

                <div id="loadingQuestions" class="loading">Loading questions...</div>
                <div id="questionsList" class="questions-list" style="display: none;"></div>
            </div>

            <!-- Template Builder Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Your Template</h2>
                    <span class="badge" id="selectedCount">0</span>
                </div>

                <div id="emptyMessage" class="alert alert-warning">
                    No minigames selected yet. Click minigames from the left panel to add them here.
                </div>

                <div id="selectedList" class="selected-list" style="display: none;"></div>

                <div class="template-form" id="templateForm" style="display: none;">
                    <div id="editModeInfo" class="alert alert-info" style="display: none;">
                        <strong id="editModeTitle"></strong>
                    </div>
                    
                    <div class="form-group">
                        <label for="templateName">Template Name *</label>
                        <input 
                            type="text" 
                            id="templateName" 
                            placeholder="e.g., Intro to Statistics Game"
                            required>
                    </div>

                    <button type="button" class="btn btn-primary" id="saveTemplateBtn">
                        üíæ Save Template
                    </button>
                </div>

                <div id="successMessage" class="alert alert-success" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="../../shared/js/api-config.js"></script>
    <script>
        // API_BASE loaded from config
        const API_BASE = window.API_BASE;
        let token = localStorage.getItem('auth_token');
        
        if (!token) {
            alert('Please log in first');
            window.location.href = '../login.html';
        }

        let allQuestions = [];
        let allTemplates = [];
        let selectedQuestions = [];
        let selectedListSortable = null;
        let currentMode = 'new'; // 'new', 'edit', or 'copy'
        let editingTemplateId = null;

        // Game type display mapping (matching in-game instruction emojis)
        const GAME_TYPE_LABELS = {
            'speed_tap': '‚ö° Speed Tap',
            'closest_guess': 'üéØ Closest Guess',
            'push_range': 'ü§úüü¶üü•ü§õ Push Range',
            'crowd_wisdom': 'üß† Crowd Wisdom',
            'word_guess': 'üî§ Word Guess',
            'rpg_battle': '‚öîÔ∏è RPG Party Battle'
        };

        // Switch between new/load modes
        function switchMode(mode) {
            const newBtn = document.getElementById('newTemplateBtn');
            const loadBtn = document.getElementById('loadTemplateBtn');
            const loadPanel = document.getElementById('loadTemplatePanel');
            const mainGrid = document.querySelector('.main-grid');

            if (mode === 'new') {
                newBtn.classList.add('active');
                loadBtn.classList.remove('active');
                loadPanel.style.display = 'none';
                mainGrid.style.display = 'grid';
                
                // Clear any editing state
                currentMode = 'new';
                editingTemplateId = null;
                selectedQuestions = [];
                document.getElementById('templateName').value = '';
                document.getElementById('editModeInfo').style.display = 'none';
                renderSelected();
                renderQuestions();
            } else if (mode === 'load') {
                newBtn.classList.remove('active');
                loadBtn.classList.add('active');
                loadPanel.style.display = 'block';
                mainGrid.style.display = 'none';
                
                loadTemplates();
            }
        }

        // Load all templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/game/templates/`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                allTemplates = await response.json();
                renderTemplates();
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templatesList').innerHTML = 
                    '<div class="alert alert-warning">Error loading templates. Please try again.</div>';
            }
        }

        // Render templates list
        function renderTemplates() {
            const container = document.getElementById('templatesList');
            
            if (allTemplates.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No templates created yet. Create your first one!</div>';
                return;
            }

            container.innerHTML = allTemplates.map(template => {
                const minigameCount = template.question_count || 0;
                const createdDate = new Date(template.created_at).toLocaleDateString();
                
                return `
                    <div class="template-card">
                        <div class="template-card-header">
                            <div class="template-card-title">${template.name}</div>
                        </div>
                        <div class="template-card-meta">
                            <span>üéÆ ${minigameCount} minigame${minigameCount !== 1 ? 's' : ''}</span>
                            <span>üìÖ Created ${createdDate}</span>
                        </div>
                        <div class="template-card-actions">
                            <button class="template-action-btn edit" onclick="loadTemplateForEdit(${template.id}, 'edit')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="template-action-btn copy" onclick="loadTemplateForEdit(${template.id}, 'copy')">
                                üìã Copy
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load a template for editing or copying
        async function loadTemplateForEdit(templateId, mode) {
            try {
                const response = await fetch(`${API_BASE}/game/templates/${templateId}/`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                const template = await response.json();
                
                currentMode = mode;
                editingTemplateId = mode === 'edit' ? templateId : null;
                
                // Load the questions from the template
                selectedQuestions = template.questions || [];
                
                // Set the template name
                if (mode === 'edit') {
                    document.getElementById('templateName').value = template.name;
                    document.getElementById('editModeTitle').textContent = `‚úèÔ∏è Editing: ${template.name}`;
                } else {
                    document.getElementById('templateName').value = template.name + ' (Copy)';
                    document.getElementById('editModeTitle').textContent = `üìã Copying: ${template.name}`;
                }
                
                document.getElementById('editModeInfo').style.display = 'block';
                
                // Switch to edit view
                switchMode('new');
                renderSelected();
                renderQuestions();
                
            } catch (error) {
                console.error('Error loading template:', error);
                alert('Error loading template: ' + error.message);
            }
        }

        // Load courses for filter
        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE}/courses/`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                const courses = await response.json();
                
                const select = document.getElementById('courseFilter');
                courses.forEach(course => {
                    select.innerHTML += `<option value="${course.id}">${course.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Load all questions
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE}/game-questions/?include_all=true`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                allQuestions = await response.json();
                
                document.getElementById('loadingQuestions').style.display = 'none';
                document.getElementById('questionsList').style.display = 'block';
                
                renderQuestions();
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('loadingQuestions').innerHTML = 
                    '<div class="alert alert-warning">Error loading questions. Please try again.</div>';
            }
        }

        // Render filtered questions
        function renderQuestions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const gameTypeFilter = document.getElementById('gameTypeFilter').value;
            const courseFilterValue = document.getElementById('courseFilter').value;
            const courseFilterId = courseFilterValue ? parseInt(courseFilterValue) : null;

            const filtered = allQuestions.filter(q => {
                // Check if already selected
                if (selectedQuestions.some(sq => sq.id === q.id)) return false;
                
                // Search filter
                if (searchTerm && !q.question_text.toLowerCase().includes(searchTerm)) return false;
                
                // Game type filter
                if (gameTypeFilter && q.game_type !== gameTypeFilter) return false;
                
                // Course filter (matches any associated course)
                if (courseFilterId) {
                    const courseIds = Array.isArray(q.course_ids) && q.course_ids.length
                        ? q.course_ids
                        : (q.course_id ? [q.course_id] : []);
                    if (!courseIds.includes(courseFilterId)) return false;
                }
                
                return true;
            });

            document.getElementById('availableCount').textContent = filtered.length;

            const container = document.getElementById('questionsList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No minigames match your filters.</div>';
                return;
            }

            container.innerHTML = filtered.map(q => {
                const courseNames = Array.isArray(q.course_names) ? q.course_names : [];
                const courseLabel = courseNames.length > 0 ? courseNames.join(', ') : 'Any Course';
                const gameTypeLabel = GAME_TYPE_LABELS[q.game_type] || q.game_type;

                return `
                <div class="question-card">
                    <div class="question-text" onclick="addQuestion(${q.id})" style="cursor: pointer; flex: 1;">${q.question_text}</div>
                    <button class="inspect-btn" onclick="event.stopPropagation(); inspectQuestion(${q.id})" title="View full details">üëÅÔ∏è</button>
                    <div class="question-meta">
                        <span>üéÆ ${gameTypeLabel}</span>
                        <span>üìò ${courseLabel}</span>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Add question to template
        function addQuestion(questionId) {
            const question = allQuestions.find(q => q.id === questionId);
            if (!question || selectedQuestions.some(q => q.id === questionId)) return;

            selectedQuestions.push(question);
            renderSelected();
            renderQuestions(); // Re-render to mark as added
        }

        // Remove question from template
        function removeQuestion(index) {
            selectedQuestions.splice(index, 1);
            renderSelected();
            renderQuestions();
        }

        // Render selected questions
        function renderSelected() {
            const count = selectedQuestions.length;
            document.getElementById('selectedCount').textContent = count;

            if (selectedListSortable) {
                selectedListSortable.destroy();
                selectedListSortable = null;
            }

            if (count === 0) {
                document.getElementById('emptyMessage').style.display = 'block';
                document.getElementById('selectedList').style.display = 'none';
                document.getElementById('templateForm').style.display = 'none';
                return;
            }

            document.getElementById('emptyMessage').style.display = 'none';
            document.getElementById('selectedList').style.display = 'block';
            document.getElementById('templateForm').style.display = 'block';

            const container = document.getElementById('selectedList');
            container.innerHTML = selectedQuestions.map((q, index) => {
                const gameTypeLabel = GAME_TYPE_LABELS[q.game_type] || q.game_type;
                
                return `
                <div class="selected-item" data-question-id="${q.id}">
                    <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
                    <div class="order-number">${index + 1}</div>
                    <div class="item-content">
                        <div class="item-text">${q.question_text.substring(0, 60)}${q.question_text.length > 60 ? '...' : ''}</div>
                        <div class="item-type">üéÆ ${gameTypeLabel}</div>
                    </div>
                    <button class="inspect-btn" onclick="event.stopPropagation(); inspectQuestion(${q.id})" title="View full details">üëÅÔ∏è</button>
                    <button class="remove-btn" onclick="removeQuestion(${index})">‚úï</button>
                </div>
            `;
            }).join('');

            initSelectedListDrag();
        }

        function initSelectedListDrag() {
            const listElement = document.getElementById('selectedList');
            if (!listElement || listElement.children.length === 0 || typeof Sortable === 'undefined') {
                return;
            }

            selectedListSortable = Sortable.create(listElement, {
                handle: '.drag-handle',
                animation: 150,
                onEnd(evt) {
                    if (evt.oldIndex === evt.newIndex || evt.oldIndex == null || evt.newIndex == null) {
                        return;
                    }

                    const [movedQuestion] = selectedQuestions.splice(evt.oldIndex, 1);
                    if (!movedQuestion) {
                        return;
                    }
                    selectedQuestions.splice(evt.newIndex, 0, movedQuestion);

                    setTimeout(() => {
                        renderSelected();
                    }, 0);
                }
            });
        }

        // Save template
        document.getElementById('saveTemplateBtn').addEventListener('click', async function() {
            const name = document.getElementById('templateName').value.trim();
            
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            if (selectedQuestions.length === 0) {
                alert('Please add at least one minigame');
                return;
            }

            this.disabled = true;
            this.textContent = 'Saving...';

            try {
                let response;
                
                if (currentMode === 'edit' && editingTemplateId) {
                    // Update existing template
                    response = await fetch(`${API_BASE}/game/templates/${editingTemplateId}/update/`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            question_ids: selectedQuestions.map(q => q.id)
                        })
                    });
                } else {
                    // Create new template (for 'new' or 'copy' mode)
                    response = await fetch(`${API_BASE}/game/templates/create/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            question_ids: selectedQuestions.map(q => q.id)
                        })
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save template');
                }

                const template = await response.json();
                
                const successMsg = document.getElementById('successMessage');
                const action = currentMode === 'edit' ? 'updated' : 'saved';
                successMsg.textContent = `‚úÖ Template "${template.name}" ${action} successfully! (${template.question_count} minigames)`;
                successMsg.style.display = 'block';

                // Reset form
                setTimeout(() => {
                    currentMode = 'new';
                    editingTemplateId = null;
                    selectedQuestions = [];
                    document.getElementById('templateName').value = '';
                    document.getElementById('editModeInfo').style.display = 'none';
                    renderSelected();
                    renderQuestions();
                    successMsg.style.display = 'none';
                }, 3000);

            } catch (error) {
                alert('Error saving template: ' + error.message);
            } finally {
                this.disabled = false;
                this.textContent = 'üíæ Save Template';
            }
        });

        // Event listeners for filters
        document.getElementById('searchInput').addEventListener('input', renderQuestions);
        document.getElementById('gameTypeFilter').addEventListener('change', renderQuestions);
        document.getElementById('courseFilter').addEventListener('change', renderQuestions);

        // Inspection modal functions
        async function inspectQuestion(questionId) {
            try {
                const response = await fetch(`${API_BASE}/game-questions/${questionId}/`, {
                    headers: {'Authorization': `Token ${token}`}
                });
                
                if (response.ok) {
                    const question = await response.json();
                    showInspectionModal(question);
                } else {
                    alert('Error loading question details');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function showInspectionModal(question) {
            const modal = document.getElementById('inspectionModal');
            const body = document.getElementById('inspectionModalBody');
            
            // Format game type label
            const gameTypeLabel = GAME_TYPE_LABELS[question.game_type] || question.game_type;
            
            // Format dates
            const createdDate = new Date(question.created_at).toLocaleString();
            const updatedDate = new Date(question.updated_at).toLocaleString();
            
            // Build game-specific details
            let gameSpecificHTML = '';
            
            if (question.game_type === 'speed_tap' && question.game_config.options) {
                const correctIndex = question.game_config.correct_option_index;
                gameSpecificHTML = `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Options</div>
                        <div class="inspection-field-value">
                            ${question.game_config.options.map((opt, i) => 
                                `${i + 1}. ${opt} ${i === correctIndex ? '<strong style="color: #10b981;">(‚úì Correct)</strong>' : ''}`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            } else if (question.game_type === 'crowd_wisdom' && question.game_config.options) {
                const correctIndex = question.game_config.correct_option_index;
                gameSpecificHTML = `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Options</div>
                        <div class="inspection-field-value">
                            ${question.game_config.options.map((opt, i) => 
                                `${i + 1}. ${opt} ${i === correctIndex ? '<strong style="color: #10b981;">(‚úì Correct)</strong>' : ''}`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            } else if (question.game_type === 'closest_guess') {
                gameSpecificHTML = `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Range</div>
                        <div class="inspection-field-value">
                            Min: ${question.game_config.min_value} | Max: ${question.game_config.max_value}
                        </div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Correct Value</div>
                        <div class="inspection-field-value">
                            <strong style="color: #10b981;">${question.game_config.correct_value}</strong>
                        </div>
                    </div>
                    ${question.game_config.max_range_width ? `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Max Range Width</div>
                        <div class="inspection-field-value">${question.game_config.max_range_width}</div>
                    </div>
                    ` : ''}
                `;
            } else if (question.game_type === 'push_range') {
                gameSpecificHTML = `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Correct Value</div>
                        <div class="inspection-field-value">
                            <strong style="color: #10b981;">${question.game_config.correct_value}%</strong>
                        </div>
                    </div>
                    ${question.game_config.target_zone_start || question.game_config.target_zone_end ? `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Target Zone</div>
                        <div class="inspection-field-value">
                            ${question.game_config.target_zone_start || 0}% - ${question.game_config.target_zone_end || 100}%
                        </div>
                    </div>
                    ` : ''}
                `;
            } else if (question.game_type === 'word_guess') {
                gameSpecificHTML = `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Answer</div>
                        <div class="inspection-field-value">
                            <strong style="color: #10b981; font-size: 1.2rem; letter-spacing: 0.1em;">${question.game_config.answer}</strong>
                        </div>
                    </div>
                    ${question.game_config.hint ? `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Hint</div>
                        <div class="inspection-field-value">${question.game_config.hint}</div>
                    </div>
                    ` : ''}
                `;
            }
            
            body.innerHTML = `
                <!-- Metainformation Section -->
                <div class="inspection-section">
                    <div class="inspection-section-title">üìã Metainformation</div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Question ID</div>
                        <div class="inspection-field-value">${question.id}</div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Game Type</div>
                        <div class="inspection-field-value">${gameTypeLabel}</div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Difficulty</div>
                        <div class="inspection-field-value">
                            <span class="inspection-badge ${question.difficulty}">${question.difficulty.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Time Limit</div>
                        <div class="inspection-field-value">${question.time_limit_seconds} seconds</div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Tags</div>
                        <div class="inspection-field-value">${question.tags || '<em style="color: #94a3b8;">No tags</em>'}</div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Created By</div>
                        <div class="inspection-field-value">${question.created_by_username || 'Unknown'}</div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Created At</div>
                        <div class="inspection-field-value">${createdDate}</div>
                    </div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Last Updated</div>
                        <div class="inspection-field-value">${updatedDate}</div>
                    </div>
                </div>
                
                <!-- Question Content Section -->
                <div class="inspection-section">
                    <div class="inspection-section-title">‚ùì Question Content</div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">Question Text</div>
                        <div class="inspection-field-value" style="font-size: 1.1rem; font-weight: 500;">${question.question_text}</div>
                    </div>
                    ${question.image_url ? `
                    <div class="inspection-field">
                        <div class="inspection-field-label">Image URL</div>
                        <div class="inspection-field-value">
                            <a href="${question.image_url}" target="_blank" style="color: #3b82f6; text-decoration: underline;">${question.image_url}</a>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Game-Specific Details Section -->
                <div class="inspection-section">
                    <div class="inspection-section-title">üéÆ Game-Specific Details</div>
                    ${gameSpecificHTML}
                </div>
                
                <!-- Raw Config Section -->
                <div class="inspection-section">
                    <div class="inspection-section-title">‚öôÔ∏è Raw Configuration</div>
                    <div class="inspection-field">
                        <div class="inspection-field-label">game_config (JSON)</div>
                        <div class="inspection-field-value code">${JSON.stringify(question.game_config, null, 2)}</div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeInspectionModal() {
            const modal = document.getElementById('inspectionModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Initialize
        loadCourses();
        loadQuestions();
    </script>
    
    <!-- Inspection Modal -->
    <div id="inspectionModal" class="inspection-modal" onclick="if(event.target === this) closeInspectionModal()">
        <div class="inspection-modal-content">
            <div class="inspection-modal-header">
                <h2>üëÅÔ∏è Question Details</h2>
                <button class="inspection-modal-close" onclick="closeInspectionModal()">√ó</button>
            </div>
            <div class="inspection-modal-body" id="inspectionModalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <script src="../../shared/js/admin-nav.js"></script>
    <footer style="text-align: center; padding: 2rem 1rem; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <img src="../../art_assets/svg_logos/praxisplay_notext_logo.svg" alt="Praxis Play" style="width: 20px; height: 20px; opacity: 0.8;">
            <span>Powered by <strong>Praxis Play</strong></span>
        </div>
        <div style="opacity: 0.7; font-size: 0.85rem;">Dr. Baker Marketing | Engaging Analytics Education</div>
    </footer>
</body>
</html>
