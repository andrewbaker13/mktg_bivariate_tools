<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Analytics | Dr. Baker Marketing</title>
    <link rel="icon" type="image/svg+xml" href="../art_assets/svg_logos/clr_notext_logo.svg">
    <link rel="stylesheet" href="../shared/css/main.css">
    <link rel="stylesheet" href="../shared/css/admin-nav.css">
    <script src="../shared/js/tracking.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        .course-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
        .course-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
        }
        .stat-card.green {
            border-left-color: #10b981;
        }
        .stat-card.orange {
            border-left-color: #f59e0b;
        }
        .stat-card.purple {
            border-left-color: #8b5cf6;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0.5rem 0;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        .student-table {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 2rem 0;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f9fafb;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        tr:hover {
            background: #f9fafb;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .badge-high {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-medium {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-low {
            background: #fee2e2;
            color: #991b1b;
        }
        .btn {
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .btn:hover {
            background: #2563eb;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        @media (max-width: 968px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Game Card Styles */
        .game-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.25rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .game-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }
        .game-room-code {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            font-family: monospace;
            letter-spacing: 0.1em;
        }
        .game-status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .game-status-badge.waiting {
            background: #dbeafe;
            color: #1e40af;
        }
        .game-status-badge.in_progress {
            background: #d1fae5;
            color: #065f46;
        }
        .game-status-badge.completed {
            background: #f3f4f6;
            color: #374151;
        }
        .game-status-badge.cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        .game-card-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        .game-stat-box {
            text-align: center;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 4px;
        }
        .game-stat-label {
            font-size: 0.7rem;
            color: #6b7280;
            text-transform: uppercase;
        }
        .game-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-top: 0.25rem;
        }
        .game-card-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
        }
        .game-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .game-btn-primary {
            background: #3b82f6;
            color: white;
        }
        .game-btn-primary:hover {
            background: #2563eb;
        }
        .game-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        .game-btn-secondary:hover {
            background: #e5e7eb;
        }
        /* Registration Codes Styling */
        .code-card {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .code-card code {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            display: block;
            margin: 0.5rem 0;
        }
        .code-status {
            font-size: 0.75rem;
            color: #6b7280;
        }
        /* Quiz List Styling */
        #quiz-list {
            max-height: 400px;
            overflow-y: auto;
        }
        #quiz-list li {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #quiz-list li:last-child {
            border-bottom: none;
        }
        .quiz-title {
            font-weight: 600;
            color: #1f2937;
        }
        .quiz-meta {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        /* Student Detail Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .modal-header h2 {
            margin: 0;
            color: #1f2937;
        }
        .close-btn {
            font-size: 2rem;
            font-weight: bold;
            color: #6b7280;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover {
            color: #1f2937;
        }
        .student-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .detail-card {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 4px;
        }
        .detail-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        .detail-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        .activity-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
        }
        .activity-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #6b7280;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 0.25rem;
            vertical-align: middle;
        }
        .info-icon:hover {
            background: #374151;
        }
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 0.75rem;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* Custom Date Range Picker Styles */
        .custom-date-range {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            animation: slideDown 0.2s ease-out;
        }
        .custom-date-range.visible {
            display: flex;
            flex-wrap: wrap;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-date-range label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }
        .custom-date-range input[type="date"] {
            padding: 0.35rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
        }
        .custom-date-range input[type="date"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .custom-date-range .apply-btn {
            padding: 0.35rem 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        .custom-date-range .apply-btn:hover {
            background: #2563eb;
        }
        .custom-date-range .apply-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .date-range-badge {
            display: none;
            background: #dbeafe;
            color: #1e40af;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        .date-range-badge.visible {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="admin-nav-container"></div>
    <div class="dashboard-container">
        <header class="intro hero-header">
            <div class="hero-header__top">
                <h1>üìä Course Analytics</h1>
                <div class="hero-context">
                    <span class="badge">Instructor Dashboard</span>
                </div>
            </div>
            <p class="hero-header__lede">
                Monitor student engagement and track course performance.
            </p>
        </header>

        <!-- Course Selector -->
        <div class="course-selector">
            <div style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1rem;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="course-select" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Select Course:</label>
                    <select id="course-select">
                        <option value="">Loading courses...</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <button id="customize-tools-btn" class="btn" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 0.95rem; display: none;">
                        ‚öôÔ∏è Customize Tools
                    </button>
                    <span id="hidden-tools-badge" style="display: none; background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                        <span id="hidden-tools-count">0</span> tools hidden
                    </span>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>Loading analytics...</p>
        </div>

        <div id="dashboard-content" style="display: none;">
            <!-- Engagement Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">
                        Total Students
                        <span class="tooltip-container">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">Total number of students currently enrolled in this course with active enrollment status.</span>
                        </span>
                    </div>
                    <div class="stat-number" id="total-students">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">
                        Active Students
                        <span class="tooltip-container">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">Number of students who have used at least one statistical tool or analysis feature in the course.</span>
                        </span>
                    </div>
                    <div class="stat-number" id="active-students">0</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">
                        Engagement Rate
                        <span class="tooltip-container">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">Percentage of students who have been active in the last 7 days. Calculated as (students active in last 7 days / total students) √ó 100.</span>
                        </span>
                    </div>
                    <div class="stat-number" id="engagement-rate">0%</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">
                        Total Tool Runs
                        <span id="total-runs-filtered-badge" style="display: none; background: #dbeafe; color: #1e40af; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem; margin-left: 0.25rem;">FILTERED</span>
                        <span class="tooltip-container">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">Total number of times students have executed statistical analysis tools across all features in this course.</span>
                        </span>
                    </div>
                    <div class="stat-number" id="total-runs">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        Avg Runs/Student
                        <span id="avg-runs-filtered-badge" style="display: none; background: #dbeafe; color: #1e40af; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem; margin-left: 0.25rem;">FILTERED</span>
                        <span class="tooltip-container">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">Average number of tool executions per student. Calculated as total tool runs divided by total enrolled students.</span>
                        </span>
                    </div>
                    <div class="stat-number" id="avg-runs">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">
                        Tools Adopted
                        <span id="tools-adopted-filtered-badge" style="display: none; background: #dbeafe; color: #1e40af; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem; margin-left: 0.25rem;">FILTERED</span>
                        <span class="tooltip-container">
                            <span class="info-icon">?</span>
                            <span class="tooltip-text">Number of unique statistical tools that have been used by students out of 22 available tools. Higher adoption indicates broader exploration of course materials.</span>
                        </span>
                    </div>
                    <div class="stat-number" id="tools-adopted">0/22</div>
                </div>
            </div>

            <!-- At-Risk Students Dashboard -->
            <div class="at-risk-container" id="at-risk-dashboard" style="display: none;">
                <div class="chart-container">
                    <h3>‚ö†Ô∏è At-Risk Students</h3>
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 1.5rem;">
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #991b1b;" id="high-risk-count">0</div>
                            <div style="font-size: 0.875rem; color: #991b1b;">High Risk</div>
                        </div>
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #92400e;" id="medium-risk-count">0</div>
                            <div style="font-size: 0.875rem; color: #92400e;">Medium Risk</div>
                        </div>
                        <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #065f46;" id="low-risk-count">0</div>
                            <div style="font-size: 0.875rem; color: #065f46;">On Track</div>
                        </div>
                    </div>
                    <div id="at-risk-list"></div>
                </div>
            </div>

            <!-- Activity Heatmap -->
            <div class="chart-container" id="heatmap-section" style="display: none;">
                <h3>üìÖ Class Activity Patterns</h3>
                <div id="heatmap-viz"></div>
                <div id="peak-hours" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- Charts -->
            <div class="chart-grid">
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0;">
                            üìà Course Activity Timeline
                            <span id="date-range-badge" class="date-range-badge"></span>
                        </h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select id="timeline-range" style="padding: 0.35rem 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 0.85rem;">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="all">All Time</option>
                                <option value="custom">Custom Range...</option>
                            </select>
                            <select id="timeline-view" style="padding: 0.35rem 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 0.85rem;">
                                <option value="aggregate" selected>Overall Activity</option>
                                <option value="by_tool">By Tool</option>
                            </select>
                        </div>
                    </div>
                    <!-- Custom Date Range Picker -->
                    <div id="custom-date-range" class="custom-date-range">
                        <label for="date-start">From:</label>
                        <input type="date" id="date-start">
                        <label for="date-end">To:</label>
                        <input type="date" id="date-end">
                        <button class="apply-btn" id="apply-date-range" disabled>Apply</button>
                    </div>
                    <div style="height: 280px;">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">üî• Most Used Tools</h3>
                        <span id="tools-chart-filter-badge" style="display: none; background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Filtered</span>
                    </div>
                    <div style="height: 320px;">
                        <canvas id="toolsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Student Activity Table -->
            <div class="student-table">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h3 style="margin: 0;">Student Activity</h3>
                        <p id="student-table-filter-note" style="display: none; margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #6b7280;">‚ö†Ô∏è Note: Totals include all tools. Use tool chart for filtered view.</p>
                    </div>
                    <button class="btn" onclick="exportStudentData()">‚¨á Export CSV</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Email</th>
                            <th>Total Runs</th>
                            <th>Tools Used</th>
                            <th>Most Used Tool</th>
                            <th>Last Active</th>
                            <th>Engagement</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body"></tbody>
                </table>
            </div>

            <!-- Management Links -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
                <!-- Registration Codes Link -->
                <div class="chart-container">
                    <h3 style="margin: 0 0 1rem 0;">üé´ Registration Codes</h3>
                    <p style="color: #6b7280; margin-bottom: 1rem;">Manage student registration codes for this course</p>
                    <a href="instructor.html" class="btn" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; text-decoration: none; display: inline-block; font-weight: 500;">
                        Manage Registration Codes ‚Üí
                    </a>
                </div>

                <!-- Quizzes -->
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üìù My Quizzes</h3>
                        <a href="quiz/quiz-manager.html" class="btn" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; display: inline-block;">+ New Quiz</a>
                    </div>
                    <ul id="quiz-list" style="list-style: none; padding: 0;"></ul>
                    <div id="no-quizzes" style="display: none; text-align: center; padding: 2rem; color: #6b7280;">
                        <p>üìù No quizzes created yet.</p>
                    </div>
                </div>
            </div>

            <!-- Hosted Games Section -->
            <div class="chart-container" id="hosted-games-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">üéÆ Hosted Games</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="game-status-filter" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="">All Statuses</option>
                            <option value="waiting">Waiting</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div id="hosted-games-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;"></div>
                <div id="no-hosted-games" style="display: none; text-align: center; padding: 2rem; color: #6b7280;">
                    <p>üéÆ No games hosted yet for this course.</p>
                    <p style="font-size: 0.875rem;">Visit the <a href="games/game-host.html" style="color: #3b82f6;">Game Host page</a> to create your first game!</p>
                </div>
            </div>
        </div>

        <!-- Game Results Modal -->
        <div id="game-results-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; margin: 2rem auto; max-width: 1200px; border-radius: 8px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 id="modal-game-title">Game Results</h2>
                    <button onclick="closeGameResultsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="filter-guests-checkbox">
                        <span>Hide Guest Players</span>
                    </label>
                    <button class="btn" onclick="exportGameResults()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">‚¨á Export Results</button>
                </div>
                <div id="modal-game-results"></div>
            </div>
        </div>

        <!-- Tool Customization Modal -->
        <div id="tool-visibility-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; margin: 2rem auto; max-width: 700px; border-radius: 8px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>‚öôÔ∏è Customize Visible Tools</h2>
                    <button onclick="closeToolVisibilityModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">
                    Select which tools appear in your course analytics. Hidden tools will not show in charts, tables, or reports.
                </p>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <button onclick="selectAllTools(true)" class="btn" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                        ‚úì Show All
                    </button>
                    <button onclick="selectAllTools(false)" class="btn" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                        ‚úó Hide All
                    </button>
                </div>
                
                <!-- Tool List -->
                <div id="tool-visibility-list" style="border: 1px solid #e5e7eb; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                    <p style="padding: 1rem; color: #6b7280;">Loading tools...</p>
                </div>
                
                <!-- Summary -->
                <div id="visibility-summary" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; display: none;">
                    <span id="visible-count">0</span> of <span id="total-tools-count">0</span> tools visible
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                    <button onclick="closeToolVisibilityModal()" class="btn" style="background: #e5e7eb; color: #374151; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveToolVisibility()" class="btn" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">
                        üíæ Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Detail Modal -->
        <div id="student-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; margin: 2rem auto; max-width: 1200px; border-radius: 8px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 id="modal-student-name">Student Details</h2>
                    <button onclick="closeStudentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div id="modal-student-content"></div>
            </div>
        </div>
    </div>

    <script src="../shared/js/auth_tracking.js"></script>
    <script>
        let currentCourseId = null;
        let studentData = [];
        let allToolsData = []; // Store all tools data for filtering calculations
        let timelineChart = null;
        let toolsChart = null;
        let toolVisibilityData = []; // Store current tool visibility settings
        let visibleToolIds = null; // Set of visible tool IDs for filtering
        let lastTimelineData = null; // Cache timeline data for re-rendering
        let customDateStart = null; // Store custom date range start
        let customDateEnd = null; // Store custom date range end

        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = 'login.html?redirect=instructor-analytics.html';
        }
        
        // Custom date range setup
        const timelineRangeSelect = document.getElementById('timeline-range');
        const customDateRangeDiv = document.getElementById('custom-date-range');
        const dateStartInput = document.getElementById('date-start');
        const dateEndInput = document.getElementById('date-end');
        const applyDateRangeBtn = document.getElementById('apply-date-range');
        const dateRangeBadge = document.getElementById('date-range-badge');
        
        // Set default date range (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        dateEndInput.value = today.toISOString().split('T')[0];
        dateStartInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        dateEndInput.max = today.toISOString().split('T')[0]; // Can't pick future dates
        
        // Show/hide custom date picker based on dropdown selection
        timelineRangeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                customDateRangeDiv.classList.add('visible');
                validateDateRange(); // Check if current inputs are valid
            } else {
                customDateRangeDiv.classList.remove('visible');
                customDateStart = null;
                customDateEnd = null;
                dateRangeBadge.classList.remove('visible');
                refreshTimeline();
            }
        });
        
        // Validate date range whenever inputs change
        function validateDateRange() {
            const start = dateStartInput.value;
            const end = dateEndInput.value;
            const isValid = start && end && new Date(start) <= new Date(end);
            applyDateRangeBtn.disabled = !isValid;
            return isValid;
        }
        
        dateStartInput.addEventListener('change', validateDateRange);
        dateEndInput.addEventListener('change', validateDateRange);
        
        // Apply custom date range
        applyDateRangeBtn.addEventListener('click', () => {
            if (validateDateRange()) {
                customDateStart = dateStartInput.value;
                customDateEnd = dateEndInput.value;
                
                // Show badge with date range
                const startFormatted = new Date(customDateStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endFormatted = new Date(customDateEnd).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dateRangeBadge.textContent = `${startFormatted} ‚Äì ${endFormatted}`;
                dateRangeBadge.classList.add('visible');
                
                refreshTimeline();
            }
        });
        
        // Timeline control event listeners
        document.getElementById('timeline-view').addEventListener('change', () => refreshTimeline());
        
        async function refreshTimeline() {
            if (!currentCourseId) return;
            
            const token = getAuthToken();
            const rangeValue = document.getElementById('timeline-range').value;
            const view = document.getElementById('timeline-view').value;
            const byTool = view === 'by_tool';
            
            // Build URL with either preset days or custom date range
            let url;
            if (rangeValue === 'custom' && customDateStart && customDateEnd) {
                url = `${API_BASE}/analytics/course/${currentCourseId}/timeline/?start_date=${customDateStart}&end_date=${customDateEnd}&by_tool=${byTool}`;
            } else {
                const days = rangeValue;
                url = `${API_BASE}/analytics/course/${currentCourseId}/timeline/?days=${days}&by_tool=${byTool}`;
            }
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                const data = await response.json();
                lastTimelineData = data;
                
                if (byTool && data.tool_series) {
                    renderTimelineChartByTool(data);
                } else {
                    renderTimelineChart(data.timeline || []);
                }
            } catch (error) {
                console.error('Failed to refresh timeline:', error);
            }
        }

        async function loadCourses() {
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE}/courses/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                const courses = await response.json();
                
                const select = document.getElementById('course-select');
                select.innerHTML = '<option value="">-- Select a course --</option>';
                
                // API returns array directly, not wrapped in {courses: [...]}
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = `${course.name} (${course.student_count} students)`;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', (e) => {
                    if (e.target.value) {
                        loadCourseAnalytics(parseInt(e.target.value));
                    }
                });
                
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        async function loadCourseAnalytics(courseId) {
            currentCourseId = courseId;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            
            const token = getAuthToken();
            
            try {
                // First load tool visibility settings
                await loadToolVisibilitySettings(courseId);
                
                // Show the customize tools button
                document.getElementById('customize-tools-btn').style.display = 'block';
                
                // Load all analytics data in parallel
                const [engagement, students, tools, timeline] = await Promise.all([
                    fetch(`${API_BASE}/analytics/course/${courseId}/engagement/`, {
                        headers: { 'Authorization': `Token ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE}/analytics/course/${courseId}/students/`, {
                        headers: { 'Authorization': `Token ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE}/analytics/course/${courseId}/tools/`, {
                        headers: { 'Authorization': `Token ${token}` }
                    }).then(r => r.json()),
                    fetch(`${API_BASE}/analytics/course/${courseId}/timeline/`, {
                        headers: { 'Authorization': `Token ${token}` }
                    }).then(r => r.json())
                ]);
                
                // Filter tools by visibility
                const filteredTools = filterToolsByVisibility(tools.tools);
                const allTools = tools.tools || [];
                
                // Calculate filtered stats
                const hasFilter = visibleToolIds && toolVisibilityData.some(t => !t.is_visible);
                let displayStats = {
                    totalRuns: engagement.usage.total_runs,
                    avgRuns: engagement.usage.avg_runs_per_student,
                    toolsUsed: engagement.usage.tools_used
                };
                
                if (hasFilter) {
                    // Recalculate stats based on filtered tools only
                    const filteredTotalRuns = filteredTools.reduce((sum, t) => sum + t.total_runs, 0);
                    const totalStudents = engagement.students.total || 1;
                    displayStats = {
                        totalRuns: filteredTotalRuns,
                        avgRuns: Math.round(filteredTotalRuns / totalStudents * 10) / 10,
                        toolsUsed: filteredTools.length
                    };
                }
                
                // Update stats (with filtered values if applicable)
                document.getElementById('total-students').textContent = engagement.students.total;
                document.getElementById('active-students').textContent = engagement.students.with_activity;
                document.getElementById('engagement-rate').textContent = engagement.students.engagement_rate + '%';
                document.getElementById('total-runs').textContent = displayStats.totalRuns;
                document.getElementById('avg-runs').textContent = displayStats.avgRuns;
                document.getElementById('tools-adopted').textContent = `${displayStats.toolsUsed}/${hasFilter ? filteredTools.length + toolVisibilityData.filter(t => !t.is_visible).length : 22}`;
                
                // Render charts (with filtered tools)
                renderTimelineChart(timeline.timeline);
                renderToolsChart(filteredTools);
                
                // Store all tools data for student filtering
                allToolsData = allTools;
                
                // Render student table (pass filtering info)
                studentData = students.students;
                renderStudentTable(studentData, hasFilter);
                
                // Load advanced analytics
                loadAtRiskStudents(courseId);
                loadActivityHeatmap(courseId);
                
                // Load hosted games
                loadHostedGames(courseId);
                
                // Load quizzes
                loadQuizzes();
                
                // Show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('loading').innerHTML = '<p style="color: #dc2626;">Error loading analytics. Please try again.</p>';
            }
        }
        
        // =================================================================
        // TOOL VISIBILITY MANAGEMENT
        // =================================================================
        
        async function loadToolVisibilitySettings(courseId) {
            const token = getAuthToken();
            try {
                const response = await fetch(`${API_BASE}/analytics/course/${courseId}/tool-visibility/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    toolVisibilityData = data.tools;
                    visibleToolIds = new Set(data.tools.filter(t => t.is_visible).map(t => t.id));
                    
                    // Update hidden tools badge
                    const hiddenCount = data.tools.filter(t => !t.is_visible).length;
                    updateHiddenToolsBadge(hiddenCount);
                } else {
                    // If endpoint fails, show all tools
                    toolVisibilityData = [];
                    visibleToolIds = null;
                    updateHiddenToolsBadge(0);
                }
            } catch (error) {
                console.error('Error loading tool visibility:', error);
                toolVisibilityData = [];
                visibleToolIds = null;
                updateHiddenToolsBadge(0);
            }
        }
        
        function updateHiddenToolsBadge(count) {
            const badge = document.getElementById('hidden-tools-badge');
            const countSpan = document.getElementById('hidden-tools-count');
            const filterNote = document.getElementById('student-table-filter-note');
            const chartBadge = document.getElementById('tools-chart-filter-badge');
            
            if (count > 0) {
                badge.style.display = 'inline-block';
                countSpan.textContent = count;
                filterNote.style.display = 'block';
                if (chartBadge) chartBadge.style.display = 'inline-block';
                // Show stat card badges
                showStatFilterBadges(true);
            } else {
                badge.style.display = 'none';
                filterNote.style.display = 'none';
                if (chartBadge) chartBadge.style.display = 'none';
                // Hide stat card badges
                showStatFilterBadges(false);
            }
        }
        
        function showStatFilterBadges(show) {
            const badgeIds = ['total-runs-filtered-badge', 'avg-runs-filtered-badge', 'tools-adopted-filtered-badge'];
            badgeIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = show ? 'inline' : 'none';
            });
        }
        
        function filterToolsByVisibility(tools) {
            if (!visibleToolIds) return tools; // No filter if visibility not loaded
            return tools.filter(tool => {
                // Match by slug or name
                const matchingTool = toolVisibilityData.find(t => 
                    t.slug === tool.tool__slug || t.name === tool.tool__name
                );
                return !matchingTool || matchingTool.is_visible;
            });
        }
        
        function openToolVisibilityModal() {
            renderToolVisibilityList();
            document.getElementById('tool-visibility-modal').style.display = 'block';
        }
        
        function closeToolVisibilityModal() {
            document.getElementById('tool-visibility-modal').style.display = 'none';
        }
        
        function renderToolVisibilityList() {
            const list = document.getElementById('tool-visibility-list');
            
            if (toolVisibilityData.length === 0) {
                list.innerHTML = '<p style="padding: 1rem; color: #6b7280;">No tools with tracking found. Tools will appear here once they have usage data.</p>';
                return;
            }
            
            // Group tools by category (if we can infer from slug)
            const groupedTools = {};
            toolVisibilityData.forEach(tool => {
                const category = inferToolCategory(tool.slug);
                if (!groupedTools[category]) groupedTools[category] = [];
                groupedTools[category].push(tool);
            });
            
            let html = '';
            Object.keys(groupedTools).sort().forEach(category => {
                html += `<div style="border-bottom: 1px solid #e5e7eb; padding: 0.75rem 1rem; background: #f9fafb; font-weight: 600; color: #374151;">
                    ${category}
                </div>`;
                groupedTools[category].forEach(tool => {
                    const checked = tool.is_visible ? 'checked' : '';
                    html += `
                        <label style="display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background 0.15s;"
                               onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                            <input type="checkbox" data-tool-id="${tool.id}" ${checked} 
                                   style="width: 18px; height: 18px; margin-right: 0.75rem; cursor: pointer;"
                                   onchange="updateVisibilitySummary()">
                            <span style="flex: 1;">${tool.name}</span>
                            <span style="color: #9ca3af; font-size: 0.875rem;">${tool.slug}</span>
                        </label>
                    `;
                });
            });
            
            list.innerHTML = html;
            updateVisibilitySummary();
            document.getElementById('visibility-summary').style.display = 'block';
        }
        
        function inferToolCategory(slug) {
            const categories = {
                'regression': ['bivariate-regression', 'multiple-linear-regression', 'logistic-regression', 'multinomial-logistic', 'mlr-interactions'],
                'hypothesis-testing': ['chi-square', 'independent-ttest', 'paired-ttest', 'oneway-anova', 'ab-proportion', 'mcnemar'],
                'clustering': ['kmeans', 'kprototypes'],
                'time-series': ['arimax'],
                'probability': ['compound-probability', 'selection-probability'],
                'sample-size': ['sample-size'],
                'text-analysis': ['sentiment', 'theme', 'qualitative'],
                'descriptive': ['pearson', 'univariate'],
                'advanced': ['neural-network', 'conjoint', 'propensity', 'resource-allocation']
            };
            
            for (const [category, keywords] of Object.entries(categories)) {
                if (keywords.some(kw => slug.toLowerCase().includes(kw))) {
                    return category.charAt(0).toUpperCase() + category.slice(1).replace('-', ' ');
                }
            }
            return 'Other';
        }
        
        function updateVisibilitySummary() {
            const checkboxes = document.querySelectorAll('#tool-visibility-list input[type="checkbox"]');
            const visibleCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            document.getElementById('visible-count').textContent = visibleCount;
            document.getElementById('total-tools-count').textContent = checkboxes.length;
        }
        
        function selectAllTools(visible) {
            const checkboxes = document.querySelectorAll('#tool-visibility-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = visible);
            updateVisibilitySummary();
        }
        
        async function saveToolVisibility() {
            const token = getAuthToken();
            const checkboxes = document.querySelectorAll('#tool-visibility-list input[type="checkbox"]');
            
            const tools = Array.from(checkboxes).map(cb => ({
                tool_id: parseInt(cb.dataset.toolId),
                is_visible: cb.checked
            }));
            
            try {
                const response = await fetch(`${API_BASE}/analytics/course/${currentCourseId}/tool-visibility/update/`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tools })
                });
                
                if (response.ok) {
                    // Update local visibility data immediately
                    tools.forEach(t => {
                        const tool = toolVisibilityData.find(td => td.id === t.tool_id);
                        if (tool) tool.is_visible = t.is_visible;
                    });
                    
                    // Update badge
                    const hiddenCount = toolVisibilityData.filter(t => !t.is_visible).length;
                    updateHiddenToolsBadge(hiddenCount);
                    
                    closeToolVisibilityModal();
                    // Reload analytics with new visibility settings
                    loadCourseAnalytics(currentCourseId);
                    alert('‚úì Tool visibility settings saved!');
                } else {
                    const error = await response.json();
                    alert('Failed to save: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving tool visibility:', error);
                alert('Failed to save tool visibility settings');
            }
        }
        
        // Hook up the customize button
        document.getElementById('customize-tools-btn').addEventListener('click', openToolVisibilityModal);

        function renderTimelineChart(timelineData) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) timelineChart.destroy();
            
            // Format dates based on range
            const rangeValue = document.getElementById('timeline-range').value;
            const dataLength = timelineData.length;
            
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                // For custom ranges or longer periods, use shorter format
                if (rangeValue === 'custom' || rangeValue === 'all' || rangeValue === '90' || dataLength > 30) {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else if (rangeValue === '7' || dataLength <= 7) {
                    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                }
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            };
            
            const labels = timelineData.map(d => formatDate(d.date));
            const data = timelineData.map(d => d.count);
            
            // Calculate appropriate tick limits based on data length
            const tickLimit = dataLength <= 7 ? 7 : (dataLength <= 30 ? 15 : Math.min(20, Math.ceil(dataLength / 3)));
            
            timelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tool Runs',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: tickLimit
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Tool Runs'
                            }
                        }
                    }
                }
            });
        }
        
        function renderTimelineChartByTool(data) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) timelineChart.destroy();
            
            const rangeValue = document.getElementById('timeline-range').value;
            const dataLength = data.dates ? data.dates.length : 30;
            
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                if (rangeValue === 'custom' || rangeValue === 'all' || rangeValue === '90' || dataLength > 30) {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else if (rangeValue === '7' || dataLength <= 7) {
                    return date.toLocaleDateString('en-US', { weekday: 'short' });
                }
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            };
            
            const labels = data.dates.map(d => formatDate(d));
            
            // Color palette for tools (distinct colors)
            const toolColors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#22c55e', '#eab308'
            ];
            
            // Calculate point radius based on data length
            const pointRadius = dataLength <= 7 ? 4 : (dataLength <= 30 ? 2 : 1);
            const tickLimit = dataLength <= 7 ? 7 : (dataLength <= 30 ? 15 : Math.min(20, Math.ceil(dataLength / 3)));
            
            const datasets = data.tool_series.map((tool, index) => ({
                label: tool.tool_name.length > 20 ? tool.tool_name.substring(0, 18) + '...' : tool.tool_name,
                data: tool.data,
                borderColor: toolColors[index % toolColors.length],
                backgroundColor: toolColors[index % toolColors.length] + '20',
                fill: false,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: pointRadius,
                pointHoverRadius: 5
            }));
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                padding: 8
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: tickLimit
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Tool Runs'
                            }
                        }
                    }
                }
            });
        }

        function renderToolsChart(toolsData) {
            const ctx = document.getElementById('toolsChart').getContext('2d');
            
            if (toolsChart) toolsChart.destroy();
            
            // Show top 10 tools as horizontal bar chart
            const top10 = toolsData.slice(0, 10);
            const labels = top10.map(t => {
                // Truncate long names but keep readable
                const name = t.tool__name || t.name || 'Unknown';
                return name.length > 25 ? name.substring(0, 22) + '...' : name;
            });
            const data = top10.map(t => t.total_runs);
            const uniqueUsers = top10.map(t => t.unique_users || 0);
            
            // Color gradient based on position (darker = more used)
            const colors = [
                '#1e40af', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd',
                '#a5b4fc', '#c4b5fd', '#d8b4fe', '#e9d5ff', '#f3e8ff'
            ];
            
            toolsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Runs',
                        data: data,
                        backgroundColor: colors.slice(0, top10.length),
                        borderColor: colors.slice(0, top10.length).map(c => c),
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const users = uniqueUsers[idx];
                                    return users ? `${users} unique students` : '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Runs',
                                font: { size: 11 }
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        async function loadAtRiskStudents(courseId) {
            try {
                const response = await fetch(`${API_BASE}/analytics/course/${courseId}/at-risk/`, {
                    headers: { 'Authorization': `Token ${getAuthToken()}` }
                });
                const data = await response.json();
                
                document.getElementById('high-risk-count').textContent = data.summary.high_risk;
                document.getElementById('medium-risk-count').textContent = data.summary.medium_risk;
                document.getElementById('low-risk-count').textContent = data.summary.low_risk;
                
                const list = document.getElementById('at-risk-list');
                const riskyStudents = data.students.filter(s => s.risk_level !== 'low');
                
                if (riskyStudents.length === 0) {
                    list.innerHTML = '<p style="color: #6b7280; text-align: center;">‚úÖ All students are on track!</p>';
                } else {
                    list.innerHTML = riskyStudents.map(student => `
                        <div style="background: ${student.color === 'red' ? '#fee2e2' : '#fef3c7'}; padding: 1rem; border-radius: 8px; margin: 0.5rem 0; cursor: pointer;"
                             onclick="loadStudentDetail(${student.student_id})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 700;">${student.icon} ${student.first_name} ${student.last_name}</span>
                                    <span style="color: #6b7280; margin-left: 0.5rem;">(${student.username})</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">${student.metrics.total_runs} runs, ${student.metrics.days_since_activity} days inactive</div>
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                ${student.risk_factors.join(' ‚Ä¢ ')}
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('at-risk-dashboard').style.display = 'block';
            } catch (error) {
                console.error('Error loading at-risk students:', error);
            }
        }

        async function loadActivityHeatmap(courseId) {
            try {
                const response = await fetch(`${API_BASE}/analytics/course/${courseId}/heatmap/`, {
                    headers: { 'Authorization': `Token ${getAuthToken()}` }
                });
                const data = await response.json();
                
                // Display peak hours
                if (data.peak_hours.length > 0) {
                    document.getElementById('peak-hours').innerHTML = `
                        <h4>üìä Peak Activity Hours:</h4>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${data.peak_hours.map(([hour, count]) => `
                                <div style="background: #dbeafe; padding: 0.75rem; border-radius: 4px;">
                                    <div style="font-weight: 700;">${hour}:00</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">${count} activities</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    document.getElementById('heatmap-section').style.display = 'block';
                } else {
                    document.getElementById('heatmap-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading activity heatmap:', error);
            }
        }

        async function loadStudentDetail(studentId) {
            try {
                const response = await fetch(`${API_BASE}/analytics/student/${studentId}/`, {
                    headers: { 'Authorization': `Token ${getAuthToken()}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load student');
                }
                
                const data = await response.json();
                
                // Build student name from response
                const studentName = data.student ? 
                    `${data.student.first_name || ''} ${data.student.last_name || ''} (${data.student.username})` :
                    'Student Details';
                
                document.getElementById('modal-student-name').textContent = studentName;
                
                // Filter tool usage by visibility if enabled
                let filteredToolUsage = data.tool_usage || [];
                if (visibleToolIds && toolVisibilityData.length > 0) {
                    filteredToolUsage = filteredToolUsage.filter(tool => {
                        const matchingTool = toolVisibilityData.find(t => t.name === tool.tool);
                        return !matchingTool || matchingTool.is_visible;
                    });
                }
                
                // Filter recent activity by visibility if enabled
                let filteredActivity = data.recent_activity || [];
                if (visibleToolIds && toolVisibilityData.length > 0) {
                    filteredActivity = filteredActivity.filter(activity => {
                        const matchingTool = toolVisibilityData.find(t => t.name === activity.tool);
                        return !matchingTool || matchingTool.is_visible;
                    });
                }
                
                // Calculate filtered totals
                const filteredTotalRuns = filteredToolUsage.reduce((sum, t) => sum + t.count, 0);
                const filteredUniqueTools = filteredToolUsage.length;
                
                document.getElementById('modal-student-content').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.875rem; color: #6b7280;">Total Runs${visibleToolIds ? ' (filtered)' : ''}</div>
                            <div style="font-size: 2rem; font-weight: 700;">${visibleToolIds ? filteredTotalRuns : (data.total_runs || 0)}</div>
                        </div>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.875rem; color: #6b7280;">Unique Tools${visibleToolIds ? ' (filtered)' : ''}</div>
                            <div style="font-size: 2rem; font-weight: 700;">${visibleToolIds ? filteredUniqueTools : (data.unique_tools || 0)}</div>
                        </div>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.875rem; color: #6b7280;">Active Days</div>
                            <div style="font-size: 2rem; font-weight: 700;">${data.unique_days || 0}</div>
                        </div>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.875rem; color: #6b7280;">Days Since Activity</div>
                            <div style="font-size: 2rem; font-weight: 700;">${data.days_since_activity !== null ? data.days_since_activity : 'Never'}</div>
                        </div>
                    </div>
                    
                    <h4>Tool Usage:${visibleToolIds ? ' <span style="font-size: 0.75rem; color: #6b7280;">(filtered)</span>' : ''}</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
                        ${filteredToolUsage.length > 0 ? filteredToolUsage.slice(0, 10).map(tool => `
                            <div style="background: #dbeafe; padding: 0.5rem 1rem; border-radius: 4px;">
                                ${tool.tool}: ${tool.count}
                            </div>
                        `).join('') : '<p style="color: #6b7280;">No tool usage recorded</p>'}
                    </div>
                    
                    <h4>Recent Activity:${visibleToolIds ? ' <span style="font-size: 0.75rem; color: #6b7280;">(filtered)</span>' : ''}</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${filteredActivity.length > 0 ? filteredActivity.map(activity => `
                            <div style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                                <div style="font-weight: 600;">${activity.tool}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    ${new Date(activity.timestamp).toLocaleString()} ‚Ä¢ ${activity.scenario || 'Custom data'}
                                </div>
                            </div>
                        `).join('') : '<p style="color: #6b7280; text-align: center;">No recent activity</p>'}
                    </div>
                `;
                
                document.getElementById('student-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading student details:', error);
                alert('Failed to load student details: ' + error.message);
            }
        }

        function closeStudentModal() {
            document.getElementById('student-modal').style.display = 'none';
        }

        function renderStudentTable(students, isFiltered = false) {
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '';
            
            // Get visible tool slugs for note
            const hiddenToolCount = toolVisibilityData.filter(t => !t.is_visible).length;
            
            students.forEach(student => {
                const tr = document.createElement('tr');
                
                const lastActive = student.last_activity ? 
                    new Date(student.last_activity).toLocaleDateString() : 'Never';
                
                // Note: total_runs and tools_used come from the API which doesn't filter
                // We show the unfiltered data with a note that it's unfiltered
                let engagementBadge = '';
                if (student.total_runs === 0) {
                    engagementBadge = '<span class="badge badge-low">Inactive</span>';
                } else if (student.total_runs >= 20) {
                    engagementBadge = '<span class="badge badge-high">High</span>';
                } else if (student.total_runs >= 5) {
                    engagementBadge = '<span class="badge badge-medium">Medium</span>';
                } else {
                    engagementBadge = '<span class="badge badge-low">Low</span>';
                }
                
                // Show most used tool, but add indicator if it's a hidden tool
                let mostUsedDisplay = student.most_used_tool || '-';
                if (student.most_used_tool && isFiltered) {
                    const isHidden = toolVisibilityData.find(t => 
                        t.name === student.most_used_tool && !t.is_visible
                    );
                    if (isHidden) {
                        mostUsedDisplay = `<span style="color: #9ca3af;" title="This tool is hidden">${student.most_used_tool} üëÅÔ∏è‚Äçüó®Ô∏è</span>`;
                    }
                }
                
                tr.innerHTML = `
                    <td><strong>${student.username}</strong></td>
                    <td>${student.email || '-'}</td>
                    <td>${student.total_runs}${isFiltered ? '*' : ''}</td>
                    <td>${student.tools_used}${isFiltered ? '*' : ''}</td>
                    <td>${mostUsedDisplay}</td>
                    <td>${lastActive}</td>
                    <td>${engagementBadge}</td>
                    <td><button class="btn" onclick="viewStudentDetail(${student.id}, '${student.username}')" style="background: #3b82f6; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">View</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280;">No students enrolled yet.</td></tr>';
            }
            
            // Add footnote if filtered
            if (isFiltered && students.length > 0) {
                const footerRow = document.createElement('tr');
                footerRow.innerHTML = `<td colspan="8" style="font-size: 0.75rem; color: #6b7280; font-style: italic; padding-top: 0.5rem;">
                    * Totals include all tools. Click "View" for filtered breakdown. ${hiddenToolCount} tool(s) hidden.
                </td>`;
                tbody.appendChild(footerRow);
            }
        }

        function exportStudentData() {
            if (studentData.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Check if filtering is active
            const isFiltered = visibleToolIds && toolVisibilityData.some(t => !t.is_visible);
            const hiddenTools = toolVisibilityData.filter(t => !t.is_visible).map(t => t.name);
            
            // Create CSV content
            let csv = '';
            
            // Add filter note if applicable
            if (isFiltered) {
                csv += `"NOTE: Tool visibility filter is active. ${hiddenTools.length} tool(s) hidden: ${hiddenTools.join(', ')}"\n`;
                csv += `"Student totals below include ALL tools. Use student detail view for filtered counts."\n\n`;
            }
            
            const headers = ['Username', 'Email', 'Total Runs (All Tools)', 'Tools Used (All)', 'Most Used Tool', 'Last Active', 'First Active'];
            const rows = studentData.map(s => [
                s.username,
                s.email || '',
                s.total_runs,
                s.tools_used,
                s.most_used_tool || '',
                s.last_activity ? new Date(s.last_activity).toLocaleString() : 'Never',
                s.first_activity ? new Date(s.first_activity).toLocaleString() : 'Never'
            ]);
            
            csv += headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filterSuffix = isFiltered ? '_filtered' : '';
            a.download = `course_${currentCourseId}_students${filterSuffix}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Game History Functions
        let allGames = [];
        let currentGameResults = null;
        
        async function loadHostedGames(courseId) {
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE}/instructor/game-history/?course_id=${courseId}`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                
                if (!response.ok) {
                    console.log('Game history not available');
                    return;
                }
                
                const data = await response.json();
                allGames = data.games || [];
                
                if (allGames.length === 0) {
                    document.getElementById('hosted-games-section').style.display = 'block';
                    document.getElementById('no-hosted-games').style.display = 'block';
                    return;
                }
                
                // Add status filter listener
                document.getElementById('game-status-filter').addEventListener('change', renderHostedGames);
                
                // Show section and render
                document.getElementById('hosted-games-section').style.display = 'block';
                renderHostedGames();
                
            } catch (error) {
                console.error('Error loading hosted games:', error);
            }
        }
        
        function renderHostedGames() {
            const statusFilter = document.getElementById('game-status-filter').value;
            const filteredGames = statusFilter ? 
                allGames.filter(g => g.status === statusFilter) : allGames;
            
            const grid = document.getElementById('hosted-games-grid');
            const noGamesMsg = document.getElementById('no-hosted-games');
            
            if (filteredGames.length === 0) {
                grid.style.display = 'none';
                noGamesMsg.style.display = 'block';
                noGamesMsg.innerHTML = statusFilter ? 
                    '<p style="color: #6b7280;">No games found with this status.</p>' :
                    '<p>üéÆ No games hosted yet for this course.</p><p style="font-size: 0.875rem;">Visit the <a href="games/game-host.html" style="color: #3b82f6;">Game Host page</a> to create your first game!</p>';
                return;
            }
            
            grid.style.display = 'grid';
            noGamesMsg.style.display = 'none';
            
            grid.innerHTML = filteredGames.map(game => {
                const createdDate = new Date(game.created_at);
                const statusLabel = game.status.replace('_', ' ');
                
                return `
                    <div class="game-card">
                        <div class="game-card-header">
                            <div class="game-room-code">${game.room_code}</div>
                            <span class="game-status-badge ${game.status}">${statusLabel}</span>
                        </div>
                        <div class="game-card-stats">
                            <div class="game-stat-box">
                                <div class="game-stat-label">Players</div>
                                <div class="game-stat-value">${game.player_count}</div>
                            </div>
                            <div class="game-stat-box">
                                <div class="game-stat-label">Rounds</div>
                                <div class="game-stat-value">${game.total_rounds || 1}</div>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.875rem; color: #6b7280;">
                            <div>üìÖ ${createdDate.toLocaleDateString()} ${createdDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
                            ${game.access_mode === 'enrollment_required' ? '<div style="margin-top: 0.25rem;">üîí Enrollment Required</div>' : ''}
                        </div>
                        <div class="game-card-actions">
                            <button class="game-btn game-btn-primary" onclick="loadGameResults(${game.id})">
                                üìä View Results
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadGameResults(gameId) {
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE}/instructor/game/${gameId}/results/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                
                if (!response.ok) {
                    alert('Failed to load game results');
                    return;
                }
                
                currentGameResults = await response.json();
                renderGameResults();
                document.getElementById('game-results-modal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading game results:', error);
                alert('Failed to load game results');
            }
        }
        
        function renderGameResults() {
            if (!currentGameResults) return;
            
            const filterGuests = document.getElementById('filter-guests-checkbox').checked;
            const results = filterGuests ? 
                currentGameResults.leaderboard.filter(p => !p.is_guest) : 
                currentGameResults.leaderboard;
            
            document.getElementById('modal-game-title').textContent = 
                `Game Results: ${currentGameResults.room_code}`;
            
            const container = document.getElementById('modal-game-results');
            
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No results to display.</p>';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong>Total Players:</strong> ${currentGameResults.leaderboard.length} 
                    (${currentGameResults.leaderboard.filter(p => p.is_guest).length} guests)
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 0.75rem; background: #f9fafb; border-bottom: 2px solid #e5e7eb;">Rank</th>
                            <th style="text-align: left; padding: 0.75rem; background: #f9fafb; border-bottom: 2px solid #e5e7eb;">Player</th>
                            <th style="text-align: center; padding: 0.75rem; background: #f9fafb; border-bottom: 2px solid #e5e7eb;">Score</th>
                            <th style="text-align: center; padding: 0.75rem; background: #f9fafb; border-bottom: 2px solid #e5e7eb;">Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map((player, idx) => {
                            const rankEmoji = player.rank === 1 ? 'ü•á' : player.rank === 2 ? 'ü•à' : player.rank === 3 ? 'ü•â' : '';
                            const playerType = player.is_guest ? 'üë§ Guest' : 'üë®‚Äçüéì Student';
                            
                            return `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 0.75rem; font-weight: 700;">${rankEmoji} ${player.rank}</td>
                                    <td style="padding: 0.75rem;">${player.player_name}</td>
                                    <td style="padding: 0.75rem; text-align: center; font-weight: 600;">${player.final_score}</td>
                                    <td style="padding: 0.75rem; text-align: center;">${playerType}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            // Add filter listener
            document.getElementById('filter-guests-checkbox').addEventListener('change', renderGameResults);
        }
        
        function closeGameResultsModal() {
            document.getElementById('game-results-modal').style.display = 'none';
            currentGameResults = null;
        }
        
        function exportGameResults() {
            if (!currentGameResults) return;
            
            const filterGuests = document.getElementById('filter-guests-checkbox').checked;
            const results = filterGuests ? 
                currentGameResults.leaderboard.filter(p => !p.is_guest) : 
                currentGameResults.leaderboard;
            
            // Create CSV content
            const headers = ['Rank', 'Player Name', 'Score', 'Type'];
            const rows = results.map(p => [
                p.rank,
                p.player_name,
                p.final_score,
                p.is_guest ? 'Guest' : 'Student'
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `game_${currentGameResults.room_code}_results_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Registration Codes functions
        // Quiz functions
        async function loadQuizzes() {
            if (!currentCourseId) return;
            
            const token = getAuthToken();
            
            try {
                const response = await fetch(`${API_BASE}/quiz/manage/my-quizzes/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                
                if (!response.ok) {
                    document.getElementById('quiz-list').innerHTML = '<li style="color: #ef4444;">Unable to load quizzes</li>';
                    return;
                }
                
                const data = await response.json();
                const quizzes = data.quizzes || [];
                
                // Filter by current course
                const courseQuizzes = quizzes.filter(q => q.course_id === currentCourseId);
                
                const list = document.getElementById('quiz-list');
                const noQuizzesDiv = document.getElementById('no-quizzes');
                
                if (courseQuizzes.length === 0) {
                    list.style.display = 'none';
                    noQuizzesDiv.style.display = 'block';
                    return;
                }
                
                list.style.display = 'block';
                noQuizzesDiv.style.display = 'none';
                
                list.innerHTML = courseQuizzes.map(quiz => `
                    <li>
                        <div>
                            <div class="quiz-title">${quiz.title}</div>
                            <div class="quiz-meta">${quiz.questions_count} questions ‚Ä¢ ${quiz.attempts_count || 0} attempts</div>
                        </div>
                        <button class="btn" onclick="viewQuizAnalytics(${quiz.id}, '${quiz.title}')" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">View</button>
                    </li>
                `).join('');
                
            } catch (error) {
                console.error('Error loading quizzes:', error);
            }
        }

        function viewQuizAnalytics(quizId, quizTitle) {
            window.location.href = `quiz/quiz-analytics.html?id=${quizId}`;
        }

        // Student Detail functions
        async function viewStudentDetail(studentId, username) {
            const token = getAuthToken();
            const modal = document.getElementById('student-modal');
            document.getElementById('modal-student-name').textContent = `${username} - Detailed Analytics`;
            
            try {
                const response = await fetch(`${API_BASE}/analytics/student/${studentId}/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load student details');
                
                const data = await response.json();
                
                const content = document.getElementById('modal-student-content');
                
                // Summary stats
                const daysSince = data.days_since_activity;
                let lastActivityText = 'Never';
                if (daysSince === 0) lastActivityText = 'Today';
                else if (daysSince === 1) lastActivityText = '1 day ago';
                else if (daysSince !== null) lastActivityText = `${daysSince} days ago`;
                
                content.innerHTML = `
                    <div class="student-detail-grid">
                        <div class="detail-card">
                            <div class="detail-label">Total Runs</div>
                            <div class="detail-value">${data.total_runs || 0}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Unique Tools</div>
                            <div class="detail-value">${data.unique_tools || 0}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Active Days</div>
                            <div class="detail-value">${data.unique_days || 0}</div>
                        </div>
                        <div class="detail-card">
                            <div class="detail-label">Last Activity</div>
                            <div class="detail-value" style="font-size: 1.1rem;">${lastActivityText}</div>
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem;">Tool Usage</h3>
                    ${(data.tool_usage || []).length === 0 ? 
                        '<p style="color: #6b7280;">No tool usage yet</p>' :
                        data.tool_usage.map(tool => `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">
                                <span>${tool.tool}</span>
                                <span style="font-weight: 600;">${tool.count} runs</span>
                            </div>
                        `).join('')
                    }

                    <h3 style="margin: 2rem 0 1rem;">Recent Activity</h3>
                    <ul class="activity-list">
                        ${(data.recent_activity || []).length === 0 ?
                            '<li style="text-align: center; color: #6b7280; padding: 2rem;">No recent activity</li>' :
                            data.recent_activity.map(activity => {
                                const date = new Date(activity.timestamp);
                                const dateStr = date.toLocaleDateString();
                                const timeStr = date.toLocaleTimeString();
                                
                                return `
                                    <li class="activity-item">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <strong>${activity.tool}</strong>
                                            <span style="color: #6b7280; font-size: 0.875rem;">${dateStr} ${timeStr}</span>
                                        </div>
                                        ${activity.scenario ? `<div style="color: #6b7280; font-size: 0.875rem;">${activity.scenario}</div>` : ''}
                                    </li>
                                `;
                            }).join('')
                        }
                    </ul>
                `;
                
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading student details:', error);
                alert('Failed to load student details');
            }
        }

        function closeStudentModal() {
            document.getElementById('student-modal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const studentModal = document.getElementById('student-modal');
            const gameModal = document.getElementById('game-results-modal');
            if (event.target === studentModal) {
                closeStudentModal();
            }
            if (event.target === gameModal) {
                closeGameResultsModal();
            }
        }

        // Load courses on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadCourses);
        } else {
            loadCourses();
        }
    </script>
    <script src="../shared/js/admin-nav.js"></script>
</body>
</html>
